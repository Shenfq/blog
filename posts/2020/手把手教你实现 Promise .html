<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="å‰ç«¯å·¥ç¨‹å¸ˆ@æ‹¼å¤šå¤šï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œæ›´äº†ä¸èµ·çš„å‰ç«¯ã€"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">æ‰‹æŠŠæ‰‹æ•™ä½ å®ç° Promise Â· è‡ªç„¶é†’çš„åšå®¢</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">è‡ªç„¶é†’çš„åšå®¢</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">è‡ªç„¶é†’çš„åšå®¢</a></h1><p class="description">å‰ç«¯å·¥ç¨‹å¸ˆ@æ‹¼å¤šå¤šï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œæ›´äº†ä¸èµ·çš„å‰ç«¯ã€</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>é¦–é¡µ</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>åˆ†ç±»</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>æ ‡ç­¾</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>å…³äº</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>å½’æ¡£</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>å‹æƒ…é“¾æ¥</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li><li><a href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">æ„é€ å‡½æ•°</a><ol><li><a href="#promise-%E7%9A%84%E7%8A%B6%E6%80%81">Promise çš„çŠ¶æ€</a></li><li><a href="#%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%9C">å†…éƒ¨ç»“æœ</a></li><li><a href="#%E5%82%A8%E5%AD%98%E5%9B%9E%E8%B0%83">å‚¨å­˜å›è°ƒ</a></li></ol></li><li><a href="#resolve-%E4%B8%8E-reject">resolve ä¸ reject</a><ol><li><a href="#%E4%BF%AE%E6%94%B9%E7%8A%B6%E6%80%81">ä¿®æ”¹çŠ¶æ€</a></li><li><a href="#%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83">è°ƒç”¨å›è°ƒ</a></li></ol></li><li><a href="#then-%E6%96%B9%E6%B3%95">then æ–¹æ³•</a><ol><li><a href="#%E5%80%BC%E7%A9%BF%E9%80%8F">å€¼ç©¿é€</a></li><li><a href="#%E4%B8%80%E6%AD%A5%E4%B9%8B%E9%81%A5">ä¸€æ­¥ä¹‹é¥</a><ol></ol></li></ol></li><li><a href="#catch-%E6%96%B9%E6%B3%95">catch æ–¹æ³•</a></li><li><a href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">é™æ€æ–¹æ³•</a><ol><li><a href="#resolvereject">resolve/reject</a></li><li><a href="#all">all</a></li><li><a href="#race">race</a></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li></ol></nav></aside><section class="main"><h1>æ‰‹æŠŠæ‰‹æ•™ä½ å®ç° Promise</h1><div class="main_post_meta"><time dateTime="2020/09/01">2020-09-02</time> Â· <!-- -->shenfq</div><article><h2 id="%E5%89%8D%E8%A8%80">å‰è¨€<a class="anchor" href="#%E5%89%8D%E8%A8%80">Â§</a></h2>
<p>å¾ˆå¤š JavaScript çš„åˆå­¦è€…éƒ½æ›¾æ„Ÿå—è¿‡è¢«å›è°ƒåœ°ç‹±æ”¯é…çš„ææƒ§ï¼Œç›´è‡³æŒæ¡äº† Promise è¯­æ³•æ‰ç®—è§£è„±ã€‚è™½ç„¶å¾ˆå¤šè¯­è¨€éƒ½æ—©å·²å†…ç½®äº† Promise ï¼Œä½†æ˜¯ JavaScript ä¸­çœŸæ­£å°†å…¶å‘æ‰¬å…‰å¤§çš„è¿˜æ˜¯ jQuery 1.5 å¯¹ <code>$.ajax</code> çš„é‡æ„ï¼Œæ”¯æŒäº† Promiseï¼Œè€Œä¸”ç”¨æ³•ä¹Ÿå’Œ jQuery æ¨å´‡çš„é“¾å¼è°ƒç”¨ä¸è°‹è€Œåˆã€‚åæ¥ ES6 å‡ºä¸–ï¼Œå¤§å®¶æ‰å¼€å§‹è¿›å…¥å…¨æ°‘ Promise çš„æ—¶ä»£ï¼Œå†åæ¥ ES8 åˆå¼•å…¥äº† async è¯­æ³•ï¼Œè®© JavaScript çš„å¼‚æ­¥å†™æ³•æ›´åŠ ä¼˜é›…ã€‚</p>
<p>ä»Šå¤©æˆ‘ä»¬å°±ä¸€æ­¥ä¸€æ­¥æ¥å®ç°ä¸€ä¸ª Promiseï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰ç”¨è¿‡ Promiseï¼Œå»ºè®®å…ˆç†Ÿæ‚‰ä¸€ä¸‹ Promise è¯­æ³•å†æ¥é˜…è¯»æœ¬æ–‡ã€‚</p>
<h2 id="%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">æ„é€ å‡½æ•°<a class="anchor" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">Â§</a></h2>
<p>åœ¨å·²æœ‰çš„ <a href="https://www.ituring.com.cn/article/66566"><code>Promise/A+</code> è§„èŒƒ</a>ä¸­å¹¶æ²¡æœ‰è§„å®š promise å¯¹è±¡ä»ä½•è€Œæ¥ï¼Œåœ¨ jQuery ä¸­é€šè¿‡è°ƒç”¨ <code>$.Deferred()</code> å¾—åˆ° promise å¯¹è±¡ï¼ŒES6 ä¸­é€šè¿‡å®ä¾‹åŒ– Promise ç±»å¾—åˆ° promise å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ ES çš„è¯­æ³•ï¼Œæ„é€ ä¸€ä¸ªç±»ï¼Œé€šè¿‡å®ä¾‹åŒ–çš„æ–¹å¼è¿”å› promise å¯¹è±¡ï¼Œç”±äº Promise å·²ç»å­˜åœ¨ï¼Œæˆ‘ä»¬æš‚æ—¶ç»™è¿™ä¸ªç±»å–åä¸º <code>Deferred</code>ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª callbackï¼Œè°ƒç”¨ callback çš„æ—¶å€™éœ€ä¼ å…¥ resolveã€reject ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<h3 id="promise-%E7%9A%84%E7%8A%B6%E6%80%81">Promise çš„çŠ¶æ€<a class="anchor" href="#promise-%E7%9A%84%E7%8A%B6%E6%80%81">Â§</a></h3>
<p>Promise ä¸€å…±åˆ†ä¸ºä¸‰ä¸ªçŠ¶æ€ï¼š</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-120006.png" alt="çŠ¶æ€"></p>
<ul>
<li>â³<code>pending</code>ï¼šç­‰å¾…ä¸­ï¼Œè¿™æ˜¯ Promise çš„åˆå§‹çŠ¶æ€ï¼›<img src="https://file.shenfq.com/ipic/2020-08-29-155250.png" alt="pending"></li>
<li>ğŸ™†â€â™‚ï¸<code>fulfilled</code>ï¼šå·²ç»“æŸï¼Œæ­£å¸¸è°ƒç”¨ resolve çš„çŠ¶æ€ï¼›<img src="https://file.shenfq.com/ipic/2020-08-29-155308.png" alt="fulfilled"></li>
<li>ğŸ™…â€â™‚ï¸<code>rejected</code>ï¼šå·²æ‹’ç»ï¼Œå†…éƒ¨å‡ºç°é”™è¯¯ï¼Œæˆ–è€…æ˜¯è°ƒç”¨ reject ä¹‹åçš„çŠ¶æ€ï¼›<img src="https://file.shenfq.com/ipic/2020-08-29-155314.png" alt="rejected"></li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Promise åœ¨è¿è¡ŒæœŸé—´æœ‰ä¸€ä¸ªçŠ¶æ€ï¼Œå­˜å‚¨åœ¨ <code>[[PromiseState]]</code> ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬ä¸º Deferred æ·»åŠ ä¸€ä¸ªçŠ¶æ€ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token comment">//åŸºç¡€å˜é‡çš„å®šä¹‰</span>
<span class="token keyword">const</span> <span class="token constant">STATUS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">PENDING</span><span class="token operator">:</span> <span class="token string">'PENDING'</span><span class="token punctuation">,</span>
  <span class="token constant">FULFILLED</span><span class="token operator">:</span> <span class="token string">'FULFILLED'</span><span class="token punctuation">,</span>
  <span class="token constant">REJECTED</span><span class="token operator">:</span> <span class="token string">'REJECTED'</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>è¿™é‡Œè¿˜æœ‰ä¸ªæœ‰æ„æ€çš„äº‹æƒ…ï¼Œæ—©æœŸæµè§ˆå™¨çš„å®ç°ä¸­ fulfilled çŠ¶æ€æ˜¯ resolvedï¼Œæ˜æ˜¾ä¸ Promise è§„èŒƒä¸ç¬¦ã€‚å½“ç„¶ï¼Œç°åœ¨å·²ç»ä¿®å¤äº†ã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-064915.png" alt="Chrome Bug"></p>
<h3 id="%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%9C">å†…éƒ¨ç»“æœ<a class="anchor" href="#%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%9C">Â§</a></h3>
<p>é™¤å¼€çŠ¶æ€ï¼ŒPromise å†…éƒ¨è¿˜æœ‰ä¸ªç»“æœ <code>[[PromiseResult]]</code>ï¼Œç”¨æ¥æš‚å­˜ resolve/reject æ¥å—çš„å€¼ã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-064452.png" alt="resolve result"></p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-064521.png" alt="reject result"></p>
<p>ç»§ç»­åœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ ä¸€ä¸ªå†…éƒ¨ç»“æœã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> reason
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%E5%82%A8%E5%AD%98%E5%9B%9E%E8%B0%83">å‚¨å­˜å›è°ƒ<a class="anchor" href="#%E5%82%A8%E5%AD%98%E5%9B%9E%E8%B0%83">Â§</a></h3>
<p>ä½¿ç”¨ Promise çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šè°ƒç”¨ promise å¯¹è±¡çš„ <code>.then</code> æ–¹æ³•ï¼Œåœ¨ promise çŠ¶æ€è½¬ä¸º <code>fulfilled</code> æˆ– <code>rejected</code> çš„æ—¶å€™ï¼Œæ‹¿åˆ°å†…éƒ¨ç»“æœï¼Œç„¶ååšåç»­çš„å¤„ç†ã€‚æ‰€ä»¥æ„é€ å‡½æ•°ä¸­ï¼Œè¿˜éœ€è¦æ„é€ ä¸¤ä¸ªæ•°ç»„ï¼Œç”¨æ¥å­˜å‚¨ <code>.then</code> æ–¹æ³•ä¼ å…¥çš„å›è°ƒã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> reason
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="resolve-%E4%B8%8E-reject"><code>resolve</code> ä¸ <code>reject</code><a class="anchor" href="#resolve-%E4%B8%8E-reject">Â§</a></h2>
<h3 id="%E4%BF%AE%E6%94%B9%E7%8A%B6%E6%80%81">ä¿®æ”¹çŠ¶æ€<a class="anchor" href="#%E4%BF%AE%E6%94%B9%E7%8A%B6%E6%80%81">Â§</a></h3>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®ç° resolve å’Œ reject ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šæ”¹å˜ promise å¯¹è±¡çš„çŠ¶æ€ã€‚è€Œä¸”ä»»æ„ä¸€ä¸ªæ–¹æ³•åœ¨è¢«è°ƒç”¨ä¹‹åï¼Œå¦å¤–çš„æ–¹æ³•æ˜¯æ— æ³•è¢«è°ƒç”¨çš„ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ğŸ™†â€â™‚ï¸'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'ğŸ™…â€â™‚ï¸'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'fulfilled'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-122023.png" alt="è¿è¡Œç»“æœ"></p>
<p>æ­¤æ—¶ï¼Œæ§åˆ¶å°åªä¼šæ‰“å°å‡º <code>fulfilled</code>ï¼Œå¹¶ä¸ä¼šå‡ºç° <code>rejected</code>ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">let</span> called <span class="token comment">// ç”¨äºåˆ¤æ–­çŠ¶æ€æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value
      <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> reason
      <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83">è°ƒç”¨å›è°ƒ<a class="anchor" href="#%E8%B0%83%E7%94%A8%E5%9B%9E%E8%B0%83">Â§</a></h3>
<p>ä¿®æ”¹å®ŒçŠ¶æ€åï¼Œæ‹¿åˆ°ç»“æœçš„ promise ä¸€èˆ¬ä¼šè°ƒç”¨ then æ–¹æ³•ä¼ å…¥çš„å›è°ƒã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">let</span> called <span class="token comment">// ç”¨äºåˆ¤æ–­çŠ¶æ€æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value
      <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span>
      <span class="token comment">// è°ƒç”¨å›è°ƒ</span>
      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> reason
      <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span>
      <span class="token comment">// è°ƒç”¨å›è°ƒ</span>
      <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ç†Ÿæ‚‰ JavaScript äº‹ä»¶ç³»ç»Ÿçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œ<code>promise.then</code> æ–¹æ³•ä¸­çš„å›è°ƒä¼šè¢«æ”¾ç½®åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åå¼‚æ­¥è°ƒç”¨ã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-123307.png" alt="MDNæ–‡æ¡£"></p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å°†å›è°ƒçš„è°ƒç”¨æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ”¾åˆ° setTimeout ä¸­è¿›è¡Œå»¶è¿Ÿè°ƒç”¨ï¼Œè™½ç„¶ä¸å¤ªç¬¦åˆè§„èŒƒï¼Œä½†æ˜¯å°†å°±å°†å°±ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token keyword nil">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">let</span> called <span class="token comment">// ç”¨äºåˆ¤æ–­çŠ¶æ€æ˜¯å¦è¢«ä¿®æ”¹</span>
    <span class="token keyword">const</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// å¼‚æ­¥è°ƒç”¨</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> value
        <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span>
        <span class="token comment">// è°ƒç”¨å›è°ƒ</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// å¼‚æ­¥è°ƒç”¨</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> reason
        <span class="token comment">// ä¿®æ”¹çŠ¶æ€</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">REJECTED</span>
        <span class="token comment">// è°ƒç”¨å›è°ƒ</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å‡ºç°å¼‚å¸¸ç›´æ¥è¿›è¡Œ reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="then-%E6%96%B9%E6%B3%95">then æ–¹æ³•<a class="anchor" href="#then-%E6%96%B9%E6%B3%95">Â§</a></h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç° then æ–¹æ³•ï¼Œç”¨è¿‡ Promise çš„åŒå­¦è‚¯å®šçŸ¥é“ï¼Œthen æ–¹æ³•æ˜¯èƒ½å¤Ÿç»§ç»­è¿›è¡Œé“¾å¼è°ƒç”¨çš„ï¼Œæ‰€ä»¥ then å¿…é¡»è¦è¿”å›ä¸€ä¸ª promise å¯¹è±¡ã€‚ä½†æ˜¯åœ¨ <code>Promise/A+</code> è§„èŒƒä¸­ï¼Œæœ‰æ˜ç¡®çš„è§„å®šï¼Œthen æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å› thisï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç éªŒè¯ä¸€ä¸‹ã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-115612.png" alt="thençš„ç»“æœ"></p>
<p>å¯ä»¥çœ‹åˆ° <code>p1</code> å¯¹è±¡å’Œ <code>p2</code> æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œå¹¶ä¸” then æ–¹æ³•è¿”å›çš„ <code>p2</code> å¯¹è±¡ä¹Ÿæ˜¯ Promise çš„å®ä¾‹ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œthen æ–¹æ³•è¿˜éœ€è¦åˆ¤æ–­å½“å‰çŠ¶æ€ï¼Œå¦‚æœå½“å‰çŠ¶æ€ä¸æ˜¯ <code>pending</code> çŠ¶æ€ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ä¼ å…¥çš„å›è°ƒï¼Œè€Œä¸ç”¨å†æ”¾å…¥é˜Ÿåˆ—è¿›è¡Œç­‰å¾…ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onResolve<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">===</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å°†å›è°ƒæ”¾å…¥é˜Ÿåˆ—ä¸­</span>
      <span class="token keyword">const</span> rejectQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">rejectQueue</span>
      <span class="token keyword">const</span> resolveQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">resolveQueue</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// æš‚å­˜åˆ°æˆåŠŸå›è°ƒç­‰å¾…è°ƒç”¨</span>
        resolveQueue<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">innerValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">onResolve</span><span class="token punctuation">(</span>innerValue<span class="token punctuation">)</span>
            <span class="token comment">// æ”¹å˜å½“å‰ promise çš„çŠ¶æ€</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// æš‚å­˜åˆ°å¤±è´¥å›è°ƒç­‰å¾…è°ƒç”¨</span>
        rejectQueue<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">innerValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token function">onReject</span><span class="token punctuation">(</span>innerValue<span class="token punctuation">)</span>
            <span class="token comment">// æ”¹å˜å½“å‰ promise çš„çŠ¶æ€</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> innerValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">value</span>
      <span class="token keyword">const</span> isFulfilled <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">===</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">FULFILLED</span>
      <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> value <span class="token operator">=</span> isFulfilled
            <span class="token operator">?</span> <span class="token function">onResolve</span><span class="token punctuation">(</span>innerValue<span class="token punctuation">)</span> <span class="token comment">// æˆåŠŸçŠ¶æ€è°ƒç”¨ onResolve</span>
            <span class="token operator">:</span> <span class="token function">onReject</span><span class="token punctuation">(</span>innerValue<span class="token punctuation">)</span> <span class="token comment">// å¤±è´¥çŠ¶æ€è°ƒç”¨ onReject</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token comment">// è¿”å›ç»“æœç»™åé¢çš„ then</span>
        <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„é€»è¾‘å·²ç»å¯ä»¥åŸºæœ¬è·‘é€šï¼Œæˆ‘ä»¬å…ˆè¯•è¿è¡Œä¸€æ®µä»£ç ï¼š</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val1</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'val1'</span><span class="token punctuation">,</span> val1<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> val1 <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val2</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'val2'</span><span class="token punctuation">,</span> val2<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> val2
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>3 ç§’åï¼Œæ§åˆ¶å°å‡ºç°å¦‚ä¸‹ç»“æœï¼š</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-162512.png" alt="è¯•è¿è¡Œ"></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™åŸºæœ¬ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h3 id="%E5%80%BC%E7%A9%BF%E9%80%8F">å€¼ç©¿é€<a class="anchor" href="#%E5%80%BC%E7%A9%BF%E9%80%8F">Â§</a></h3>
<p>å¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨ then çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥ä»»ä½•çš„å‚æ•°ï¼ŒæŒ‰ç…§è§„èŒƒï¼Œå½“å‰ promise çš„å€¼æ˜¯å¯ä»¥é€ä¼ åˆ°ä¸‹ä¸€ä¸ª then æ–¹æ³•çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-163022.png" alt="å€¼ç©¿é€"></p>
<p>åœ¨æ§åˆ¶å°å¹¶æ²¡æœ‰çœ‹åˆ°ä»»ä½•è¾“å‡ºï¼Œè€Œåˆ‡æ¢åˆ° Promise æ˜¯å¯ä»¥çœ‹åˆ°æ­£ç¡®ç»“æœçš„ã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-163122.png" alt="å€¼ç©¿é€"></p>
<p>è¦è§£å†³è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ then è°ƒç”¨çš„æ—¶å€™åˆ¤æ–­å‚æ•°æ˜¯å¦ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœä¸æ˜¯åˆ™éœ€è¦ç»™ä¸€ä¸ªé»˜è®¤å€¼ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token parameter">fn</span> <span class="token arrow operator">=></span> <span class="token keyword">typeof</span> fn <span class="token operator">===</span> <span class="token string">'function'</span>

<span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onResolve<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§£å†³å€¼ç©¿é€</span>
    onReject <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function-variable function">onReject</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">throw</span> reason <span class="token punctuation">}</span>
    onResolve <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function-variable function">onResolve</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> value <span class="token punctuation">}</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">===</span> <span class="token constant">STATUS</span><span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-08-31-164124.png" alt="å€¼ç©¿é€"></p>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥æ‹¿åˆ°æ­£ç¡®ç»“æœäº†ã€‚</p>
<h3 id="%E4%B8%80%E6%AD%A5%E4%B9%8B%E9%81%A5">ä¸€æ­¥ä¹‹é¥<a class="anchor" href="#%E4%B8%80%E6%AD%A5%E4%B9%8B%E9%81%A5">Â§</a></h3>
<p>ç°åœ¨æˆ‘ä»¬è·ç¦»å®Œç¾å®ç° then æ–¹æ³•åªå·®ä¸€æ­¥ä¹‹é¥ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨ then æ–¹æ³•ä¼ å…¥çš„ <code>onResolve/onReject</code> å›è°ƒæ—¶ï¼Œè¿˜éœ€è¦åˆ¤æ–­ä»–ä»¬çš„è¿”å›å€¼ã€‚å¦‚æœå›è°ƒçš„å†…éƒ¨è¿”å›çš„å°±æ˜¯ä¸€ä¸ª promise å¯¹è±¡ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿæˆ–è€…å‡ºç°äº†å¾ªç¯å¼•ç”¨ï¼Œæˆ‘ä»¬åˆè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
<p>å‰é¢æˆ‘ä»¬åœ¨æ‹¿åˆ° <code>onResolve/onReject</code> çš„è¿”å›å€¼åï¼Œç›´æ¥å°±è°ƒç”¨äº† <code>resolve</code> æˆ–è€… <code>resolve</code>ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦æŠŠä»–ä»¬çš„è¿”å›å€¼è¿›è¡Œä¸€äº›å¤„ç†ã€‚</p>
<pre class="language-diff"><code class="language-diff">then(onResolve, onReject) {
<span class="token unchanged"><span class="token prefix unchanged"> </span> // è§£å†³å€¼ç©¿é€ä»£ç å·²ç»çœç•¥
<span class="token prefix unchanged"> </span> if (this.status === STATUS.PENDING) {
<span class="token prefix unchanged"> </span>   // å°†å›è°ƒæ”¾å…¥é˜Ÿåˆ—ä¸­
<span class="token prefix unchanged"> </span>   const rejectQueue = this.rejectQueue
<span class="token prefix unchanged"> </span>   const resolveQueue = this.resolveQueue
<span class="token prefix unchanged"> </span>   const promise = new Deferred((resolve, reject) => {
<span class="token prefix unchanged"> </span>     // æš‚å­˜åˆ°æˆåŠŸå›è°ƒç­‰å¾…è°ƒç”¨
<span class="token prefix unchanged"> </span>     resolveQueue.push(function (innerValue) {
<span class="token prefix unchanged"> </span>       try {
<span class="token prefix unchanged"> </span>         const value = onResolve(innerValue)
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>         resolve(value)
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         doThenFunc(promise, value, resolve, reject)
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>       } catch (error) {
<span class="token prefix unchanged"> </span>         reject(error)
<span class="token prefix unchanged"> </span>       }
<span class="token prefix unchanged"> </span>     })
<span class="token prefix unchanged"> </span>     // æš‚å­˜åˆ°å¤±è´¥å›è°ƒç­‰å¾…è°ƒç”¨
<span class="token prefix unchanged"> </span>     rejectQueue.push(function (innerValue) {
<span class="token prefix unchanged"> </span>       try {
<span class="token prefix unchanged"> </span>         const value = onReject(innerValue)
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>         resolve(value)
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>         doThenFunc(promise, value, resolve, reject)
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>       } catch (error) {
<span class="token prefix unchanged"> </span>         reject(error)
<span class="token prefix unchanged"> </span>       }
<span class="token prefix unchanged"> </span>     })
<span class="token prefix unchanged"> </span>   })
<span class="token prefix unchanged"> </span>   return promise
<span class="token prefix unchanged"> </span> } else {
<span class="token prefix unchanged"> </span>   const innerValue = this.value
<span class="token prefix unchanged"> </span>   const isFulfilled = this.status === STATUS.FULFILLED
<span class="token prefix unchanged"> </span>   const promise = new Deferred((resolve, reject) => {
<span class="token prefix unchanged"> </span>     try {
<span class="token prefix unchanged"> </span>       const value = isFulfilled
<span class="token prefix unchanged"> </span>       ? onResolve(innerValue) // æˆåŠŸçŠ¶æ€è°ƒç”¨ onResolve
<span class="token prefix unchanged"> </span>       : onReject(innerValue) // å¤±è´¥çŠ¶æ€è°ƒç”¨ onReject
</span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span>       resolve(value)
</span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span>       doThenFunc(promise, value, resolve, reject)
</span><span class="token unchanged"><span class="token prefix unchanged"> </span>     } catch (error) {
<span class="token prefix unchanged"> </span>       reject(error)
<span class="token prefix unchanged"> </span>     }
<span class="token prefix unchanged"> </span>   })
<span class="token prefix unchanged"> </span>   return promise
<span class="token prefix unchanged"> </span> }
</span>}
</code></pre>
<h4 id="%E8%BF%94%E5%9B%9E%E5%80%BC%E5%88%A4%E6%96%AD">è¿”å›å€¼åˆ¤æ–­<a class="anchor" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%88%A4%E6%96%AD">Â§</a></h4>
<p>åœ¨æˆ‘ä»¬ä½¿ç”¨ Promise çš„æ—¶å€™ï¼Œç»å¸¸ä¼šåœ¨ then æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œç„¶åæŠŠæ–°çš„ Promise å®Œæˆåçš„å†…éƒ¨ç»“æœå†ä¼ é€’ç»™åé¢çš„ then æ–¹æ³•ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'server/login'</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  	<span class="token comment">// è¿”å›æ–°çš„ promise å¯¹è±¡</span>
  	<span class="token keyword control-flow">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">server/order/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">order</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">doThenFunc</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¦‚æœ value æ˜¯ promise å¯¹è±¡</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Deferred</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨ then æ–¹æ³•ï¼Œç­‰å¾…ç»“æœ</span>
    value<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token function">doThenFunc</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> val<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœé promise å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="%E5%88%A4%E6%96%AD%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">åˆ¤æ–­å¾ªç¯å¼•ç”¨<a class="anchor" href="#%E5%88%A4%E6%96%AD%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">Â§</a></h4>
<p>å¦‚æœå½“å‰ then æ–¹æ³•å›è°ƒå‡½æ•°è¿”å›å€¼æ˜¯å½“å‰ then æ–¹æ³•äº§ç”Ÿçš„æ–°çš„ promise å¯¹è±¡ï¼Œåˆ™è¢«è®¤ä¸ºæ˜¯å¾ªç¯å¼•ç”¨ï¼Œå…·ä½“æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://file.shenfq.com/ipic/2020-09-01-023956.png" alt="å¾ªç¯å¼•ç”¨"></p>
<p>then æ–¹æ³•è¿”å›çš„æ–°çš„ promise å¯¹è±¡ <code>p1</code>ï¼Œåœ¨å›è°ƒä¸­è¢«å½“åšè¿”å›å€¼ï¼Œæ­¤æ—¶ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚å› ä¸ºæŒ‰ç…§ä¹‹å‰çš„é€»è¾‘ï¼Œä»£ç å°†ä¼šä¸€ç›´å›°åœ¨è¿™ä¸€æ®µé€»è¾‘é‡Œã€‚</p>
<p><img src="https://file.shenfq.com/ipic/2020-09-01-033436.png" alt="å¾ªç¯å¼•ç”¨"></p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æå‰é¢„é˜²ï¼ŒåŠæ—¶æŠ›å‡ºé”™è¯¯ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">doThenFunc</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å¾ªç¯å¼•ç”¨</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>
    	<span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœ value æ˜¯ promise å¯¹è±¡</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Deferred</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨ then æ–¹æ³•ï¼Œç­‰å¾…ç»“æœ</span>
    value<span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token function">doThenFunc</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> val<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    	<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœé promise å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å›</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å†è¯•è¯•åœ¨ then ä¸­è¿”å›ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">delayDouble</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> num<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> <span class="token function">delayDouble</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-09-01-035003.png" alt="è¿è¡Œç»“æœ"></p>
<p>ä¸Šé¢çš„ç»“æœä¹Ÿæ˜¯å®Œç¾ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h2 id="catch-%E6%96%B9%E6%B3%95">catch æ–¹æ³•<a class="anchor" href="#catch-%E6%96%B9%E6%B3%95">Â§</a></h2>
<p>catch æ–¹æ³•å…¶å®å¾ˆç®€å•ï¼Œç›¸å½“äº then æ–¹æ³•çš„ä¸€ä¸ªç®€å†™ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onResolve<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> onReject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">é™æ€æ–¹æ³•<a class="anchor" href="#%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95">Â§</a></h2>
<h3 id="resolvereject">resolve/reject<a class="anchor" href="#resolvereject">Â§</a></h3>
<p>Promise ç±»è¿˜æä¾›äº†ä¸¤ä¸ªé™æ€æ–¹æ³•ï¼Œç›´æ¥è¿”å›çŠ¶æ€å·²ç»å›ºå®šçš„ promise å¯¹è±¡ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onResolve<span class="token punctuation">,</span> onReject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="all">all<a class="anchor" href="#all">Â§</a></h3>
<p>all æ–¹æ³•æ¥å—ä¸€ä¸ª promise å¯¹è±¡çš„æ•°ç»„ï¼Œç­‰æ•°ç»„ä¸­æ‰€æœ‰çš„ promise å¯¹è±¡çš„çŠ¶æ€å˜ä¸º <code>fulfilled</code>ï¼Œç„¶åè¿”å›ç»“æœï¼Œå…¶ç»“æœä¹Ÿæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå€¼å¯¹åº”çš„æ˜¯ promise å¯¹è±¡çš„å†…éƒ¨ç»“æœã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸ºæ•°ç»„ï¼Œç„¶åæ„é€ ä¸€ä¸ªç»“æœæ•°ç»„ä»¥åŠä¸€ä¸ªæ–°çš„ promise å¯¹è±¡ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éæ•°ç»„å‚æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">Deferred</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'args must be an array'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

		<span class="token comment">// ç”¨äºå­˜å‚¨æ¯ä¸ª promise å¯¹è±¡çš„ç»“æœ</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> promises<span class="token punctuation">.</span><span class="token property-access">length</span>
    <span class="token comment">// å¦‚æœ remaining å½’é›¶ï¼Œè¡¨ç¤ºæ‰€æœ‰ promise å¯¹è±¡å·²ç» fulfilled</span>
    <span class="token keyword">let</span> remaining <span class="token operator">=</span> length 
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword control-flow">return</span> promise
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œä¸€ä¸‹åˆ¤æ–­ï¼Œå¯¹æ¯ä¸ª promise å¯¹è±¡çš„ resolve è¿›è¡Œæ‹¦æˆªï¼Œæ¯æ¬¡ resolve éƒ½éœ€è¦å°† <code>remaining</code> å‡ä¸€ï¼Œç›´åˆ° <code>remaining</code> å½’é›¶ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// éæ•°ç»„å‚æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">Deferred</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'args must be an array'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// ç”¨äºå­˜å‚¨æ¯ä¸ª promise å¯¹è±¡çš„ç»“æœ</span>
    <span class="token keyword">const</span> length <span class="token operator">=</span> promises<span class="token punctuation">.</span><span class="token property-access">length</span>

    <span class="token keyword">let</span> remaining <span class="token operator">=</span> length
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºç»“æœ</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>promises<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

      <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token parameter">index<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doThenFunc</span><span class="token punctuation">(</span>
          promise<span class="token punctuation">,</span>
          value<span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
            <span class="token comment">// resolve çš„ç»“æœæ”¾å…¥ result ä¸­</span>
            result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> val
            <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>remaining <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// å¦‚æœæ‰€æœ‰çš„ promise éƒ½å·²ç»è¿”å›ç»“æœ</span>
              <span class="token comment">// ç„¶åè¿è¡Œåé¢çš„é€»è¾‘</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          reject
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">done</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token keyword control-flow">return</span> promise
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä»£ç ï¼Œåˆ¤æ–­é€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚æŒ‰ç…§é¢„æœŸï¼Œä»£ç è¿è¡Œåï¼Œåœ¨ 3 ç§’ä¹‹åï¼Œæ§åˆ¶å°ä¼šæ‰“å°ä¸€ä¸ªæ•°ç»„ <code>[2, 4, 6]</code>ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">delayDouble</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> num<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">Deferred</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-09-01-053556.png" alt="all"></p>
<p>ä¸Šé¢çš„è¿è¡Œç»“æœï¼ŒåŸºæœ¬ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h3 id="race">race<a class="anchor" href="#race">Â§</a></h3>
<p>race æ–¹æ³•åŒæ ·æ¥å—ä¸€ä¸ª promise å¯¹è±¡çš„æ•°ç»„ï¼Œä½†æ˜¯å®ƒåªéœ€è¦æœ‰ä¸€ä¸ª promise å˜ä¸º <code>fulfilled</code> çŠ¶æ€å°±ä¼šè¿”å›ç»“æœã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Deferred</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token known-class-name class-name">Array</span><span class="token punctuation">.</span><span class="token method function property-access">isArray</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">Deferred</span><span class="token punctuation">.</span><span class="token method function property-access">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'args must be an array'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> length <span class="token operator">=</span> promises<span class="token punctuation">.</span><span class="token property-access">length</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>promises<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

      <span class="token keyword">function</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doThenFunc</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">done</span><span class="token punctuation">(</span>promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> promise
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ä¸‹é¢æˆ‘ä»¬å°†å‰é¢éªŒè¯ all æ–¹æ³•çš„æ¡ˆä¾‹æ”¹æˆ raceã€‚æŒ‰ç…§é¢„æœŸï¼Œä»£ç è¿è¡Œåï¼Œåœ¨ 1 ç§’ä¹‹åï¼Œæ§åˆ¶å°ä¼šæ‰“å°ä¸€ä¸ª2ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">delayDouble</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num<span class="token punctuation">,</span> time</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Deferred</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> num<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">Deferred</span><span class="token punctuation">.</span><span class="token method function property-access">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">delayDouble</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/ipic/2020-09-01-055513.png" alt="race"></p>
<p>ä¸Šé¢çš„è¿è¡Œç»“æœï¼ŒåŸºæœ¬ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚</p>
<h2 id="%E6%80%BB%E7%BB%93">æ€»ç»“<a class="anchor" href="#%E6%80%BB%E7%BB%93">Â§</a></h2>
<p>ä¸€ä¸ªç®€æ˜“ç‰ˆçš„ Promise ç±»å°±å·²ç»å®ç°äº†ï¼Œè¿™é‡Œè¿˜æ˜¯çœç•¥äº†éƒ¨åˆ†ç»†èŠ‚ï¼Œå®Œæ•´ä»£ç å¯ä»¥è®¿é—® <a href="https://github.com/Shenfq/polyfill/tree/master/promise">github</a>ã€‚Promise çš„å‡ºç°ä¸ºåæœŸçš„ async è¯­æ³•æ‰“ä¸‹äº†åšå®åŸºç¡€ï¼Œä¸‹ä¸€ç¯‡åšå®¢å¯ä»¥å¥½å¥½èŠä¸€èŠ JavaScript çš„å¼‚æ­¥ç¼–ç¨‹å²ï¼Œä¸å°å¿ƒåˆç»™è‡ªå·±æŒ–å‘äº†ã€‚ã€‚ã€‚</p></article></section><footer>Powered byÂ <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>