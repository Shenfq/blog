<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="å‰ç«¯å·¥ç¨‹å¸ˆ@æ‹¼å¤šå¤šï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œæ›´äº†ä¸èµ·çš„å‰ç«¯ã€"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">React æ¶æ„çš„æ¼”å˜ - Hooks çš„å®ç° Â· è‡ªç„¶é†’çš„åšå®¢</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">è‡ªç„¶é†’çš„åšå®¢</a><aside class="hide_on_mobile"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">è‡ªç„¶é†’çš„åšå®¢</a></h1><p class="description">å‰ç«¯å·¥ç¨‹å¸ˆ@æ‹¼å¤šå¤šï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œæ›´äº†ä¸èµ·çš„å‰ç«¯ã€</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>é¦–é¡µ</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>åˆ†ç±»</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>æ ‡ç­¾</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>å…³äº</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>å½’æ¡£</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>å‹æƒ…é“¾æ¥</a></li></ul></nav></aside><section class="main"><h1>React æ¶æ„çš„æ¼”å˜ - Hooks çš„å®ç°</h1><div class="main_post_meta"><time dateTime="2020/10/27">2020-10-28</time> Â· <!-- -->shenfq</div><article><blockquote>
<p>è¿™æ˜¯è¿™ä¸ªç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« äº†ï¼Œç»ˆäºæ”¶å°¾äº†ğŸ¶ ã€‚</p>
</blockquote>
<p>React Hooks å¯ä»¥è¯´å®Œå…¨é¢ è¦†äº†ä¹‹å‰ Class Component çš„å†™æ³•ï¼Œè¿›ä¸€æ­¥å¢å¼ºäº†çŠ¶æ€å¤ç”¨çš„èƒ½åŠ›ï¼Œè®© Function Component ä¹Ÿå…·æœ‰äº†å†…éƒ¨çŠ¶æ€ï¼Œå¯¹äºæˆ‘ä¸ªäººæ¥è¯´ï¼Œæ›´åŠ å–œæ¬¢ Hooks çš„å†™æ³•ã€‚å½“ç„¶å¦‚æœä½ æ˜¯ä¸€ä¸ªä½¿ç”¨ Class Component  çš„è€æ‰‹ï¼ŒåˆæœŸä¸Šæ‰‹æ—¶ä¼šè§‰å¾—å¾ˆè‹¦æ¼ï¼Œæ¯•ç«Ÿä¹‹å‰æ²‰æ·€çš„å¾ˆå¤š HOCã€Render Props ç»„ä»¶åŸºæœ¬æ²¡æ³•ç”¨ã€‚è€Œä¸”ä¹‹å‰çš„ Function Component æ˜¯æ— å‰¯ä½œç”¨çš„æ— çŠ¶æ€ç»„ä»¶ï¼Œç°åœ¨åˆèƒ½é€šè¿‡ Hooks å¼•å…¥çŠ¶æ€ï¼Œçœ‹èµ·æ¥çœŸçš„å¾ˆè®©äººç–‘æƒ‘ã€‚Function Component çš„å¦ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯å¯ä»¥å®Œå…¨å‘Šåˆ« <code>this</code> ï¼Œåœ¨ Class Component é‡Œé¢ <code>this</code> çœŸçš„æ˜¯ä¸€ä¸ªè®©äººè®¨åŒçš„ä¸œè¥¿ğŸ˜¶ ã€‚</p>
<h2 id="hook-%E5%A6%82%E4%BD%95%E4%B8%8E%E7%BB%84%E4%BB%B6%E5%85%B3%E8%81%94">Hook å¦‚ä½•ä¸ç»„ä»¶å…³è”<a class="anchor" href="#hook-%E5%A6%82%E4%BD%95%E4%B8%8E%E7%BB%84%E4%BB%B6%E5%85%B3%E8%81%94">Â§</a></h2>
<p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å¤šæ¬¡æåˆ°ï¼ŒFiber æ¶æ„ä¸‹çš„ <code>updateQueue</code>ã€<code>effectList</code> éƒ½æ˜¯é“¾è¡¨çš„æ•°æ®ç»“æ„ï¼Œç„¶åæŒ‚è½½çš„ Fiber èŠ‚ç‚¹ä¸Šã€‚è€Œä¸€ä¸ªå‡½æ•°ç»„ä»¶å†…æ‰€æœ‰çš„ Hooks ä¹Ÿæ˜¯é€šè¿‡é“¾è¡¨çš„å½¢å¼å­˜å‚¨çš„ï¼Œæœ€åæŒ‚è½½åˆ°  <code>fiber.memoizedState</code> ä¸Šã€‚</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
    <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token arrow operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">></span></span><span class="token punctuation">{</span> num <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">App</span>
</code></pre>
<p>æˆ‘ä»¬å…ˆç®€å•çœ‹ä¸‹ï¼Œè°ƒç”¨ useState æ—¶ï¼Œæ„é€ é“¾è¡¨çš„è¿‡ç¨‹ï¼š</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> workInProgressHook <span class="token operator">=</span> <span class="token keyword null nil">null</span>
<span class="token keyword">var</span> <span class="token maybe-class-name">HooksDispatcherOnMount</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">useState</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">mountState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token keyword">function</span> <span class="token function">mountState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ–°çš„ Hook èŠ‚ç‚¹</span>
  <span class="token keyword">var</span> hook <span class="token operator">=</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// ç¼“å­˜åˆå§‹å€¼</span>
  hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span> <span class="token operator">=</span> initialState
  <span class="token comment">// æ„é€ æ›´æ–°é˜Ÿåˆ—ï¼Œç±»ä¼¼äº fiber.updateQueue</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span><span class="token property-access">queue</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    pending<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    dispatch<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    lastRenderedState<span class="token operator">:</span> initialState
  <span class="token punctuation">}</span>
  <span class="token comment">// ç”¨äºæ´¾å‘æ›´æ–°</span>
  <span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token property-access">dispatch</span> <span class="token operator">=</span> dispatchAction<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span>
    <span class="token keyword null nil">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> queue
  <span class="token punctuation">)</span>
  <span class="token comment">// [num, updateNum] = useState(0)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    memoizedState<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    baseState<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    baseQueue<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    next<span class="token operator">:</span> <span class="token keyword null nil">null</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ„é€ é“¾è¡¨å¤´èŠ‚ç‚¹</span>
    workInProgress<span class="token punctuation">.</span><span class="token property-access">memoizedState</span> <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœé“¾è¡¨å·²ç»å­˜åœ¨ï¼Œåœ¨æŒ‚è½½åˆ° next</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span><span class="token property-access">next</span> <span class="token operator">=</span> hook
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> workInProgressHook
<span class="token punctuation">}</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20201026173627.png" alt="Hook"></p>
<p>å¦‚æœæ­¤æ—¶æœ‰ä¸¤ä¸ª Hookï¼Œç¬¬äºŒä¸ª Hook å°±ä¼šæŒ‚è½½åˆ°ç¬¬ä¸€ä¸ª Hook çš„ next å±æ€§ä¸Šã€‚</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>str<span class="token punctuation">,</span> updateStr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'value: '</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
    <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token arrow operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">></span></span><span class="token punctuation">{</span> str <span class="token punctuation">}</span><span class="token plain-text"> </span><span class="token punctuation">{</span> num <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">App</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20201026173832.png" alt="Hook"></p>
<h2 id="hook-%E7%9A%84%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97">Hook çš„æ›´æ–°é˜Ÿåˆ—<a class="anchor" href="#hook-%E7%9A%84%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97">Â§</a></h2>
<p>Hook é€šè¿‡ <code>.next</code> å½¼æ­¤ç›¸è¿ï¼Œè€Œæ¯ä¸ª Hook å¯¹è±¡ä¸‹ï¼Œè¿˜æœ‰ä¸ª queue å­—æ®µï¼Œè¯¥å­—æ®µå’Œ Fiber èŠ‚ç‚¹ä¸Šçš„ <code>updateQueue</code> ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—åœ¨ï¼Œä¸Šç¯‡æ–‡ç«  <a href="https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6/">ã€ŠReact æ¶æ„çš„æ¼”å˜-æ›´æ–°æœºåˆ¶ã€‹</a>ä¸­æœ‰è®²åˆ°ï¼ŒReact Fiber æ¶æ„ä¸­ï¼Œæ›´æ–°é˜Ÿåˆ—é€šè¿‡é“¾è¡¨ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> val<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
  <span class="token function">click</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> val<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">val</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">val: </span><span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">val</span> <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>ç‚¹å‡» div ä¹‹åï¼Œäº§ç”Ÿçš„ 3 æ¬¡ setState é€šè¿‡é“¾è¡¨çš„å½¢å¼æŒ‚è½½åˆ° <code>fiber.updateQueue</code> ä¸Šï¼Œå¾…åˆ° MessageChannel æ”¶åˆ°é€šçŸ¥åï¼ŒçœŸæ­£æ‰§è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œå–å‡ºæ›´æ–°é˜Ÿåˆ—ï¼Œå°†è®¡ç®—ç»“æœæ›´æ–°åˆ° <code>fiber.memoizedState </code>ã€‚</p>
<p><img src="https://file.shenfq.com/pic/20201009234826.png" alt="setState"></p>
<p>è€Œ <code>hook.queue</code> çš„é€»è¾‘å’Œ <code>fiber.updateQueue</code> çš„é€»è¾‘ä¹Ÿæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚</p>
<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>num<span class="token punctuation">,</span> updateNum<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
    <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿ç»­æ›´æ–° 3 æ¬¡</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token arrow operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token arrow operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token function">updateNum</span><span class="token punctuation">(</span><span class="token parameter">num</span> <span class="token arrow operator">=></span> num <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
  <span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token punctuation">{</span> num <span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token maybe-class-name">App</span><span class="token punctuation">;</span>
</code></pre>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token property-access">dispatch</span> <span class="token operator">=</span> dispatchAction<span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span>
  <span class="token keyword null nil">null</span><span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> queue
<span class="token punctuation">)</span>
<span class="token comment">// [num, updateNum] = useState(0)</span>
<span class="token keyword control-flow">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span>
</code></pre>
<p>è°ƒç”¨ useState çš„æ—¶å€™ï¼Œè¿”å›çš„æ•°ç»„ç¬¬äºŒä¸ªå‚æ•°ä¸º <code>dispatch</code>ï¼Œè€Œ <code>dispatch</code> ç”± <code>dispatchAction</code> bind åå¾—åˆ°ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">dispatchAction</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> update <span class="token operator">=</span> <span class="token punctuation">{</span>
    next<span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> action<span class="token punctuation">,</span>
    <span class="token comment">// çœç•¥è°ƒåº¦ç›¸å…³çš„å‚æ•°...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> pending <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token property-access">pending</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>pending <span class="token operator">===</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span><span class="token property-access">next</span> <span class="token operator">=</span> update
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    update<span class="token punctuation">.</span><span class="token property-access">next</span> <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token property-access">next</span>
    pending<span class="token punctuation">.</span><span class="token property-access">next</span> <span class="token operator">=</span> update
  <span class="token punctuation">}</span>
  queue<span class="token punctuation">.</span><span class="token property-access">pending</span> <span class="token operator">=</span> update

  <span class="token comment">// æ‰§è¡Œæ›´æ–°</span>
  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ„é€ é“¾è¡¨çš„æ–¹å¼ä¸ <code>fiber.updateQueue</code> å¦‚å‡ºä¸€è¾™ã€‚ä¹‹å‰æˆ‘ä»¬é€šè¿‡ <code>updateNum</code> å¯¹ <code>num</code> è¿ç»­æ›´æ–°äº† 3 æ¬¡ï¼Œæœ€åå½¢æˆçš„æ›´æ–°é˜Ÿåˆ—å¦‚ä¸‹ï¼š</p>
<p><img src="https://file.shenfq.com/pic/20201026223145.png" alt="æ›´æ–°é˜Ÿåˆ—"></p>
<h2 id="%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9B%B4%E6%96%B0">å‡½æ•°ç»„ä»¶çš„æ›´æ–°<a class="anchor" href="#%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E7%9A%84%E6%9B%B4%E6%96%B0">Â§</a></h2>
<p>å‰é¢çš„æ–‡ç« åˆ†äº«è¿‡ï¼ŒFiber æ¶æ„ä¸‹çš„æ›´æ–°æµç¨‹åˆ†ä¸ºé€’ï¼ˆbeginWorkï¼‰ã€å½’ï¼ˆcompleteWorkï¼‰ä¸¤ä¸ªæ­¥éª¤ï¼Œåœ¨ beginWork ä¸­ï¼Œä¼šä¾æ®ç»„ä»¶ç±»å‹è¿›è¡Œ render æ“ä½œæ„é€ å­ç»„ä»¶ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token parameter">current<span class="token punctuation">,</span> workInProgress</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">switch</span> <span class="token punctuation">(</span>workInProgress<span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…¶ä»–ç±»å‹ç»„ä»¶ä»£ç çœç•¥...</span>
    <span class="token keyword">case</span> <span class="token maybe-class-name">FunctionComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// è¿™é‡Œçš„ type å°±æ˜¯å‡½æ•°ç»„ä»¶çš„å‡½æ•°</span>
      <span class="token comment">// ä¾‹å¦‚ï¼Œå‰é¢çš„ App ç»„ä»¶ï¼Œtype å°±æ˜¯ function App() {}</span>
      <span class="token keyword">var</span> <span class="token maybe-class-name">Component</span> <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span><span class="token property-access">type</span>
      <span class="token keyword">var</span> resolvedProps <span class="token operator">=</span> workInProgress<span class="token punctuation">.</span><span class="token property-access">pendingProps</span>
      <span class="token comment">// ç»„ä»¶æ›´æ–°</span>
      <span class="token keyword control-flow">return</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
        current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token maybe-class-name">Component</span><span class="token punctuation">,</span> resolvedProps
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span>
	<span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token maybe-class-name">Component</span><span class="token punctuation">,</span> nextProps</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// æ„é€ å­ç»„ä»¶</span>
  <span class="token keyword">var</span> nextChildren <span class="token operator">=</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token maybe-class-name">Component</span><span class="token punctuation">,</span> nextProps
  <span class="token punctuation">)</span>
  <span class="token function">reconcileChildren</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> nextChildren<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> workInProgress<span class="token punctuation">.</span><span class="token property-access">child</span>
<span class="token punctuation">}</span>

</code></pre>
<p>çœ‹åå­—å°±èƒ½çœ‹å‡ºæ¥ï¼Œ<code>renderWithHooks</code> æ–¹æ³•å°±æ˜¯æ„é€ å¸¦ Hooks çš„å­ç»„ä»¶ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">renderWithHooks</span><span class="token punctuation">(</span>
	<span class="token parameter">current<span class="token punctuation">,</span> workInProgress<span class="token punctuation">,</span> <span class="token maybe-class-name">Component</span><span class="token punctuation">,</span> props</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&amp;&amp;</span> current<span class="token punctuation">.</span><span class="token property-access">memoizedState</span> <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token maybe-class-name">HooksDispatcherOnUpdate</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token maybe-class-name">HooksDispatcherOnMount</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> children <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Component</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> children
<span class="token punctuation">}</span>
</code></pre>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°ç»„ä»¶æ›´æ–°æˆ–è€…é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œæœ¬è´¨å°±æ˜¯å°†å‡½æ•°å–å‡ºæ‰§è¡Œäº†ä¸€éã€‚ä¸åŒçš„åœ°æ–¹åœ¨äºç»™ <code>ReactCurrentDispatcher </code> è¿›è¡Œäº†ä¸åŒçš„èµ‹å€¼ï¼Œè€Œ <code>ReactCurrentDispatcher</code> çš„å€¼æœ€ç»ˆä¼šå½±å“ <code>useState</code> è°ƒç”¨ä¸åŒçš„æ–¹æ³•ã€‚</p>
<p>æ ¹æ®ä¹‹å‰æ–‡ç« è®²è¿‡çš„åŒç¼“å­˜æœºåˆ¶ï¼Œcurrent å­˜åœ¨çš„æ—¶å€™è¡¨ç¤ºæ˜¯æ›´æ–°æ“ä½œï¼Œä¸å­˜åœ¨çš„æ—¶å€™è¡¨ç¤ºé¦–æ¬¡æ¸²æŸ“ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é¦–æ¬¡æ¸²æŸ“æ—¶æŒ‡å‘ HooksDispatcherOnMount</span>
  <span class="token comment">// æ›´æ–°æ“ä½œæ—¶æŒ‡å‘ HooksDispatcherOnUpdate</span>
  <span class="token keyword">var</span> dispatcher <span class="token operator">=</span> <span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span>
  <span class="token keyword control-flow">return</span> dispatcher<span class="token punctuation">.</span><span class="token method function property-access">useState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>HooksDispatcherOnMount.useState</code> çš„ä»£ç å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œè¿™é‡Œä¸å†ç€é‡ä»‹ç»ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// HooksDispatcherOnMount çš„ä»£ç å‰é¢å·²ç»ä»‹ç»è¿‡</span>
<span class="token keyword">var</span> <span class="token maybe-class-name">HooksDispatcherOnMount</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">useState</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">mountState</span><span class="token punctuation">(</span>initialState<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹ <code>HooksDispatcherOnMount.useState</code> çš„é€»è¾‘ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> <span class="token maybe-class-name">HooksDispatcherOnUpdateInDEV</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">useState</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å–å‡ºå½“å‰ hook</span>
  workInProgressHook <span class="token operator">=</span> nextWorkInProgressHook
  nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span><span class="token property-access">next</span>

  <span class="token keyword">var</span> hook <span class="token operator">=</span> nextWorkInProgressHook
  <span class="token keyword">var</span> queue <span class="token operator">=</span> hook<span class="token punctuation">.</span><span class="token property-access">queue</span>
  <span class="token keyword">var</span> pendingQueue <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token property-access">pending</span>

  <span class="token comment">// å¤„ç†æ›´æ–°</span>
  <span class="token keyword">var</span> first <span class="token operator">=</span> pendingQueue<span class="token punctuation">.</span><span class="token property-access">next</span>
  <span class="token keyword">var</span> state <span class="token operator">=</span> hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span>
  <span class="token keyword">var</span> update <span class="token operator">=</span> first

  <span class="token keyword control-flow">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> action <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token property-access">action</span>
    state <span class="token operator">=</span> <span class="token keyword">typeof</span> action <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function">action</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token operator">:</span> action

    update <span class="token operator">=</span> update<span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span>update <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&amp;&amp;</span> update <span class="token operator">!==</span> first<span class="token punctuation">)</span>


  hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span> <span class="token operator">=</span> state

  <span class="token keyword">var</span> dispatch <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token property-access">dispatch</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span>hook<span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>å¦‚æœæœ‰çœ‹ä¹‹å‰çš„ setState çš„ä»£ç ï¼Œè¿™é‡Œçš„é€»è¾‘å…¶å®æ˜¯ä¸€æ ·çš„ã€‚å°†æ›´æ–°å¯¹è±¡çš„ action å–å‡ºï¼Œå¦‚æœæ˜¯å‡½æ•°å°±æ‰§è¡Œï¼Œå¦‚æœä¸æ˜¯å‡½æ•°å°±ç›´æ¥å¯¹ state è¿›è¡Œæ›¿æ¢æ“ä½œã€‚</p>
<h2 id="%E6%80%BB%E7%BB%93">æ€»ç»“<a class="anchor" href="#%E6%80%BB%E7%BB%93">Â§</a></h2>
<p>React ç³»åˆ—çš„æ–‡ç« ç»ˆäºå†™å®Œäº†ï¼Œè¿™ä¸€ç¯‡æ–‡ç« åº”è¯¥æ˜¯æœ€ç®€å•çš„ä¸€ç¯‡ï¼Œå¦‚æœæƒ³æŠ›å¼€ React æºç ï¼Œå•ç‹¬çœ‹ Hooks å®ç°å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://github.com/brickspert/blog/issues/26">ã€ŠReact Hooks åŸç†ã€‹</a>ã€‚Fiber æ¶æ„ä¸ºäº†èƒ½å¤Ÿå®ç°å¾ªç¯çš„æ–¹å¼æ›´æ–°ï¼Œå°†æ‰€æœ‰æ¶‰åŠåˆ°æ•°æ®çš„åœ°æ–¹ç»“æ„éƒ½æ”¹æˆäº†é“¾è¡¨ï¼Œè¿™æ ·çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥éšæ—¶ä¸­æ–­ï¼Œä¸ºå¼‚æ­¥æ¨¡å¼è®©è·¯ï¼ŒFiber æ ‘å°±åƒä¸€é¢—åœ£è¯æ ‘ï¼Œä¸Šé¢æŒ‚æ»¡äº†å„ç§å½©ç¯ï¼ˆ<code>alternate</code>ã€<code>EffectList</code>ã€<code>updateQueue</code>ã€<code>Hooks</code>ï¼‰ã€‚</p>
<p>æ¨èå¤§å®¶å¯ä»¥å°†è¿™ä¸ªç³»åˆ—ä»å¤´åˆ°å°¾çœ‹ä¸€éï¼Œç›¸ä¿¡ä¼šç‰¹åˆ«æœ‰æ”¶è·çš„ã€‚</p>
<ul>
<li><a href="https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E4%BB%8E%E5%90%8C%E6%AD%A5%E5%88%B0%E5%BC%82%E6%AD%A5/">React æ¶æ„çš„æ¼”å˜ - ä»åŒæ­¥åˆ°å¼‚æ­¥</a></li>
<li><a href="https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E4%BB%8E%E9%80%92%E5%BD%92%E5%88%B0%E5%BE%AA%E7%8E%AF/">React æ¶æ„çš„æ¼”å˜ - ä»é€’å½’åˆ°å¾ªç¯</a></li>
<li><a href="https://blog.shenfq.com/2020/react-%E6%9E%B6%E6%9E%84%E7%9A%84%E6%BC%94%E5%8F%98-%E6%9B%B4%E6%96%B0%E6%9C%BA%E5%88%B6/">React æ¶æ„çš„æ¼”å˜ - æ›´æ–°æœºåˆ¶</a></li>
</ul></article></section><footer>Powered byÂ <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>