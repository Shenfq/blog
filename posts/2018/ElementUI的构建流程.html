<!doctype html><html class="" data-reactroot=""><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师@拼多多，爱折腾，擅长 JavaScript，欢迎关注我的公众号「更了不起的前端」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">ElementUI的构建流程 · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">自然醒的博客</a><aside class="hide_on_mobile"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">自然醒的博客</a></h1><p class="description">前端工程师@拼多多，爱折腾，擅长 JavaScript，欢迎关注我的公众号「更了不起的前端」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></aside><section class="main"><h1>ElementUI的构建流程</h1><div class="main_post_meta"><time dateTime="2018/09/17">2018-09-18</time> · <!-- -->shenfq</div><article><h2 id="%E8%83%8C%E6%99%AF">背景<a class="anchor" href="#%E8%83%8C%E6%99%AF">§</a></h2>
<p>最近一直在着手做一个与业务强相关的组件库，一直在思考要从哪里下手，怎么来设计这个组件库，因为业务上一直在使用ElementUI（以下简称Element），于是想参考了一下Element组件库的设计，看看Element构建方式，并且总结成了这篇文章。</p>
<p><img src="https://file.shenfq.com/18-9-14/48784910.jpg" alt="logo"></p>
<!-- more -->
<h2 id="element%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">Element的目录结构<a class="anchor" href="#element%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84">§</a></h2>
<p>废话不多说，先看看目录结构，从目录结构入手，一步步进行分解。</p>
<pre class="language-autoit"><code class="language-autoit">├─build <span class="token operator">/</span><span class="token operator">/</span> 构建相关的脚本和配置
├─examples <span class="token operator">/</span><span class="token operator">/</span> 用于展示Element组件的demo
├─lib <span class="token operator">/</span><span class="token operator">/</span> 构建后生成的文件，发布到npm包
├─packages <span class="token operator">/</span><span class="token operator">/</span> 组件代码
├─src <span class="token operator">/</span><span class="token operator">/</span> 引入组件的入口文件
├─test <span class="token operator">/</span><span class="token operator">/</span> 测试代码
├─Makefile <span class="token operator">/</span><span class="token operator">/</span> 构建文件
├─components<span class="token punctuation">.</span>json <span class="token operator">/</span><span class="token operator">/</span> 组件列表
└─package<span class="token punctuation">.</span>json
</code></pre>
<h2 id="%E6%9C%89%E5%93%AA%E4%BA%9B%E6%9E%84%E5%BB%BA%E5%91%BD%E4%BB%A4">有哪些构建命令<a class="anchor" href="#%E6%9C%89%E5%93%AA%E4%BA%9B%E6%9E%84%E5%BB%BA%E5%91%BD%E4%BB%A4">§</a></h2>
<p>刚打开的时候看到了一个Makefile文件，如果学过c/c++的同学对这个东西应该不陌生，当时看到后台同学发布版本时，写下了一句<code>make love</code>，把我和我的小伙伴们都惊呆了。说正紧的，makefile可以说是比较早出现在UNIX 系统中的工程化工具，通过一个简单的<code>make XXX</code>来执行一系列的编译和链接操作。不懂makefile文件的可以看这篇文章了解下：<a href="https://segmentfault.com/a/1190000004437816#articleHeader11">前端入门-&gt;makefile</a></p>
<p>当我们打开Element的Makefile时，发现里面的操作都是npm script的命令，我不知道为什么还要引入Makefile，直接使用<code>npm run xxx</code>就好了呀。</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token keyword">default</span><span class="token punctuation">:</span> help

install<span class="token punctuation">:</span>
	npm install
	
new<span class="token punctuation">:</span>
	node build<span class="token operator">/</span>bin<span class="token operator">/</span>new<span class="token punctuation">.</span>js $<span class="token punctuation">(</span>filter<span class="token operator">-</span>out $@<span class="token punctuation">,</span>$<span class="token punctuation">(</span>MAKECMDGOALS<span class="token punctuation">)</span><span class="token punctuation">)</span>
	
dev<span class="token punctuation">:</span>
	npm run dev
	
deploy<span class="token punctuation">:</span>
	<span class="token variable">@npm</span> run deploy
	
dist<span class="token punctuation">:</span> install
	npm run dist
	
pub<span class="token punctuation">:</span>
	npm run pub
	
help<span class="token punctuation">:</span>
	<span class="token variable">@echo</span> <span class="token string">"make 命令使用说明"</span>
	<span class="token variable">@echo</span> <span class="token string">"make install	---  安装依赖"</span>
	<span class="token variable">@echo</span> <span class="token string">"make new &lt;component-name> [中文名]	---  创建新组件 package. 例如 'make new button 按钮'"</span>
	<span class="token variable">@echo</span> <span class="token string">"make dev	---  开发模式"</span>
	<span class="token variable">@echo</span> <span class="token string">"make dist	---  编译项目，生成目标文件"</span>
	<span class="token variable">@echo</span> <span class="token string">"make deploy	---  部署 demo"</span>
	<span class="token variable">@echo</span> <span class="token string">"make pub	---  发布到 npm 上"</span>
	<span class="token variable">@echo</span> <span class="token string">"make new-lang &lt;lang>	---  为网站添加新语言. 例如 'make new-lang fr'"</span>
</code></pre>
<h2 id="%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6">开发模式与构建入口文件<a class="anchor" href="#%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F%E4%B8%8E%E6%9E%84%E5%BB%BA%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6">§</a></h2>
<p>这里我们只挑选几个重要的看看。首先看到<code>make install</code>，使用的是npm进行依赖安装，但是Element实际上是使用yarn进行依赖管理，所以如果你要在本地进行Element开发的话，最好使用yarn进行依赖安装。在官方的<a href="https://github.com/ElemeFE/element/blob/master/.github/CONTRIBUTING.zh-CN.md#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">贡献指南</a>也有提到。</p>
<p><img src="https://file.shenfq.com/18-9-8/65602547.jpg" alt="贡献指南"></p>
<p>同时在package.json文件中有个bootstrap命令就是使用yarn来安装依赖。</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"bootstrap"</span><span class="token punctuation">:</span> <span class="token string">"yarn || npm i"</span><span class="token punctuation">,</span>
</code></pre>
<p>安装完依赖之后，就可以进行开发了，运行<code>npm run dev</code>，可以通过webpack-dev-sever在本地运行Element官网的demo。</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"dev"</span><span class="token punctuation">:</span> "
    npm run bootstrap <span class="token operator">&amp;</span><span class="token operator">&amp;</span> <span class="token operator">/</span><span class="token operator">/</span> 依赖安装
    npm run build<span class="token punctuation">:</span>file <span class="token operator">&amp;</span><span class="token operator">&amp;</span> <span class="token operator">/</span><span class="token operator">/</span> 目标文件生成
    cross<span class="token operator">-</span>env NODE_ENV<span class="token operator">=</span>development webpack<span class="token operator">-</span>dev<span class="token operator">-</span>server <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>js <span class="token operator">&amp;</span> 
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>template<span class="token punctuation">.</span>js
"

<span class="token string">"build:file"</span><span class="token punctuation">:</span> " 
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>iconInit<span class="token punctuation">.</span>js <span class="token operator">&amp;</span>  <span class="token operator">/</span><span class="token operator">/</span> 解析icon<span class="token punctuation">.</span>scss，将所有小图标的name存入examples<span class="token operator">/</span>icon<span class="token punctuation">.</span>json
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>build<span class="token operator">-</span>entry<span class="token punctuation">.</span>js <span class="token operator">&amp;</span>  <span class="token operator">/</span><span class="token operator">/</span> 根据components<span class="token punctuation">.</span>json，生成入口文件
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>i18n<span class="token punctuation">.</span>js <span class="token operator">&amp;</span>  <span class="token operator">/</span><span class="token operator">/</span> 根据examples<span class="token operator">/</span>i18n<span class="token operator">/</span>page<span class="token punctuation">.</span>json和模板，生成不同语言的demo
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>version<span class="token punctuation">.</span>js <span class="token operator">/</span><span class="token operator">/</span> 生成examples<span class="token operator">/</span>versions<span class="token punctuation">.</span>json，键值对，各个大版本号对应的最新版本
"
</code></pre>
<p>在通过webpack-dev-server运行demo时，有个前置条件，就是通过<code>npm run build:file</code>生成目标文件。这里主要看下<code>node build/bin/build-entry.js</code>，这个脚本用于生成Element的入口js。先是读取根目录的components.json，这个json文件维护着Element的所有的组件名，键为组件名，值为组件源码的入口文件；然后遍历键值，将所有组件进行import，对外暴露install方法，把所有import的组件通过<code>Vue.component(name, component)</code>方式注册为全局组件，并且把一些弹窗类的组件挂载到Vue的原型链上。具体代码如下（ps：对代码进行一些精简，具体逻辑不变）：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token maybe-class-name">Components</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../components.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'json-templater/string'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> uppercamelcase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uppercamelcase'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> endOfLine <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">EOL</span><span class="token punctuation">;</span> <span class="token comment">// 换行符</span>

<span class="token keyword">var</span> includeComponentTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> installTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> listTemplate <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token maybe-class-name">Components</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> componentName <span class="token operator">=</span> <span class="token function">uppercamelcase</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将组件名转为驼峰</span>
  <span class="token keyword">var</span> componetPath <span class="token operator">=</span> <span class="token maybe-class-name">Components</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span>
  includeComponentTemplate<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> from '.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componetPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 这几个特殊组件不能直接注册成全局组件，需要挂载到Vue的原型链上</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Loading'</span><span class="token punctuation">,</span> <span class="token string">'MessageBox'</span><span class="token punctuation">,</span> <span class="token string">'Notification'</span><span class="token punctuation">,</span> <span class="token string">'Message'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    installTemplate<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>componentName <span class="token operator">!==</span> <span class="token string">'Loading'</span><span class="token punctuation">)</span> listTemplate<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* Automatically generated by './build/bin/build-entry.js' */

</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>includeComponentTemplate<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>endOfLine<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
import locale from 'element-ui/src/locale';
import CollapseTransition from 'element-ui/src/transitions/collapse-transition';

const components = [
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>installTemplate<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">','</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,
  CollapseTransition
];

const install = function(Vue, opts = {}) {
  locale.use(opts.locale);
  locale.i18n(opts.i18n);

  components.forEach(component => {
    Vue.component(component.name, component);
  });

  Vue.use(Loading.directive);

  Vue.prototype.$ELEMENT = {
    size: opts.size || '',
    zIndex: opts.zIndex || 2000
  };

  Vue.prototype.$loading = Loading.service;
  Vue.prototype.$msgbox = MessageBox;
  Vue.prototype.$alert = MessageBox.alert;
  Vue.prototype.$confirm = MessageBox.confirm;
  Vue.prototype.$prompt = MessageBox.prompt;
  Vue.prototype.$notify = Notification;
  Vue.prototype.$message = Message;

};

/* istanbul ignore if */
if (typeof window !== 'undefined' &amp;&amp; window.Vue) {
  install(window.Vue);
}

module.exports = {
  version: '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">||</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../package.json'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">',
  locale: locale.use,
  i18n: locale.i18n,
  install,
  CollapseTransition,
  Loading,
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>listTemplate<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">','</span> <span class="token operator">+</span> endOfLine<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
};

module.exports.default = module.exports;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 写文件</span>
fs<span class="token punctuation">.</span><span class="token method function property-access">writeFileSync</span><span class="token punctuation">(</span><span class="token constant">OUTPUT_PATH</span><span class="token punctuation">,</span> template<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'[build entry] DONE:'</span><span class="token punctuation">,</span> <span class="token constant">OUTPUT_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<p>最后生成的代码如下：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">/* Automatically generated by './build/bin/build-entry.js' */</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Button</span></span> <span class="token keyword module">from</span> <span class="token string">'../packages/button/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Table</span></span> <span class="token keyword module">from</span> <span class="token string">'../packages/table/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Form</span></span> <span class="token keyword module">from</span> <span class="token string">'../packages/form/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Row</span></span> <span class="token keyword module">from</span> <span class="token string">'../packages/row/index.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Col</span></span> <span class="token keyword module">from</span> <span class="token string">'../packages/col/index.js'</span><span class="token punctuation">;</span>
<span class="token comment">// some others Component</span>
<span class="token keyword module">import</span> <span class="token imports">locale</span> <span class="token keyword module">from</span> <span class="token string">'element-ui/src/locale'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">CollapseTransition</span></span> <span class="token keyword module">from</span> <span class="token string">'element-ui/src/transitions/collapse-transition'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token maybe-class-name">Button</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Table</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Form</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Row</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Menu</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Col</span><span class="token punctuation">,</span>
  <span class="token comment">// some others Component</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token maybe-class-name">Vue</span><span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  locale<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token property-access">locale</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  locale<span class="token punctuation">.</span><span class="token method function property-access">i18n</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token property-access">i18n</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  components<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">component</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token maybe-class-name">Vue</span><span class="token punctuation">.</span><span class="token method function property-access">component</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> component<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token maybe-class-name">Vue</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token maybe-class-name">Loading</span><span class="token punctuation">.</span><span class="token property-access">directive</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$</span><span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    size<span class="token operator">:</span> opts<span class="token punctuation">.</span><span class="token property-access">size</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    zIndex<span class="token operator">:</span> opts<span class="token punctuation">.</span><span class="token property-access">zIndex</span> <span class="token operator">||</span> <span class="token number">2000</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$loading</span> <span class="token operator">=</span> <span class="token maybe-class-name">Loading</span><span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$msgbox</span> <span class="token operator">=</span> <span class="token maybe-class-name">MessageBox</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$alert</span> <span class="token operator">=</span> <span class="token maybe-class-name">MessageBox</span><span class="token punctuation">.</span><span class="token property-access">alert</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$confirm</span> <span class="token operator">=</span> <span class="token maybe-class-name">MessageBox</span><span class="token punctuation">.</span><span class="token property-access">confirm</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$prompt</span> <span class="token operator">=</span> <span class="token maybe-class-name">MessageBox</span><span class="token punctuation">.</span><span class="token property-access">prompt</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$notify</span> <span class="token operator">=</span> <span class="token maybe-class-name">Notification</span><span class="token punctuation">;</span>
  <span class="token class-name">Vue</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">$message</span> <span class="token operator">=</span> <span class="token maybe-class-name">Message</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* istanbul ignore if */</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token dom variable">window</span> <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Vue</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">install</span><span class="token punctuation">(</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Vue</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  version<span class="token operator">:</span> <span class="token string">'2.4.6'</span><span class="token punctuation">,</span>
  locale<span class="token operator">:</span> locale<span class="token punctuation">.</span><span class="token property-access">use</span><span class="token punctuation">,</span>
  i18n<span class="token operator">:</span> locale<span class="token punctuation">.</span><span class="token property-access">i18n</span><span class="token punctuation">,</span>
  install<span class="token punctuation">,</span>
  <span class="token maybe-class-name">Button</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Table</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Form</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Row</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Menu</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Col</span><span class="token punctuation">,</span>
  <span class="token comment">// some others Component</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">.</span><span class="token keyword module">default</span> <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">;</span>
</code></pre>
<p>最后有个写法需要注意：<code>module.exports.default = module.exports;</code>，这里是为了兼容ESmodule，因为es6的模块<code>export default xxx</code>，在webpack中最后会变成类似于<code>exports.default = xxx</code>的形式，而<code>import ElementUI from 'element-ui';</code>会变成<code>ElementUI = require('element-ui').default</code>的形式，为了让ESmodule识别这种commonjs的写法，就需要加上default。</p>
<p>exports对外暴露的install方法就是把Element组件注册会全局组件的方法。当我们使用<code>Vue.use</code>时，就会调用对外暴露的install方法。如果我们直接通过script的方式引入vue和Element，检测到Vue为全局变量时，也会调用install方法。</p>
<pre class="language-html"><code class="language-html">// 使用方式1
<span class="token comment">&lt;!-- import Vue before Element --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><a class="token url-link" href="https://unpkg.com/vue/dist/vue.js">https://unpkg.com/vue/dist/vue.js</a><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- import JavaScript --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><a class="token url-link" href="https://unpkg.com/element-ui/lib/index.js">https://unpkg.com/element-ui/lib/index.js</a><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>

// 使用方式2
import Vue from 'vue';
import ElementUI from 'element-ui';
import 'element-ui/lib/theme-chalk/index.css';

Vue.use(ElementUI); // 此时会调用ElementUI.install()

</code></pre>
<p>在module.exports对象中，除了暴露install方法外，还把所有组件进行了对外的暴露，方便引入单个组件。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Button</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'element-ui'</span><span class="token punctuation">;</span>
<span class="token maybe-class-name">Vue</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token maybe-class-name">Button</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>但是如果你有进行按需加载，使用Element官方的babel-plugin-component插件，上面代码会转换成如下形式：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">var</span> _button <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'element-ui/lib/button'</span><span class="token punctuation">)</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'element-ui/lib/theme-chalk/button.css'</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">Vue</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>_button<span class="token punctuation">)</span>
</code></pre>
<p>那么前面module.exports对外暴露的单组件好像也没什么用。
不过这里使用<code>npm run build:file</code>生成文件的方式是可取的，因为在实际项目中，我们每新增一个组件，只需要修改components.json文件，然后使用<code>npm run build:file</code>重新生成代码就可以了，不需要手动去修改多个文件。</p>
<p>在生成了入口文件的index.js之后就会运行webpack-dev-server。</p>
<pre class="language-bash"><code class="language-bash">webpack-dev-server --config build/webpack.demo.js
</code></pre>
<p>接下来看下webpack.demo.js的入口文件：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.demo.js</span>
<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./examples/entry.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./examples/element-ui/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">CI_ENV</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'[name].[hash:7].js'</span><span class="token punctuation">,</span>
    chunkFilename<span class="token operator">:</span> isProd <span class="token operator">?</span> <span class="token string">'[name].[hash:7].js'</span> <span class="token operator">:</span> <span class="token string">'[name].js'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
    extensions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.vue'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      main<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      packages<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../packages'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      examples<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../examples'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'element-ui'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ... some other config</span>
<span class="token punctuation">}</span>

<span class="token comment">// examples/entry.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Vue</span></span> <span class="token keyword module">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Element</span></span> <span class="token keyword module">from</span> <span class="token string">'main/index.js'</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">Vue</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token maybe-class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="%E6%96%B0%E5%BB%BA%E7%BB%84%E4%BB%B6">新建组件<a class="anchor" href="#%E6%96%B0%E5%BB%BA%E7%BB%84%E4%BB%B6">§</a></h2>
<p>entry.js就是直接引入的之前build:file中生成的index.js的Element的入口文件。因为这篇文章主要讲构建流程，所以不会仔细看demo的源码。下面看看Element如何新建一个组件，在Makefile可以看到使用<code>make new xxx</code>新建一个组件。。</p>
<pre class="language-autoit"><code class="language-autoit">new<span class="token punctuation">:</span>
	node build<span class="token operator">/</span>bin<span class="token operator">/</span>new<span class="token punctuation">.</span>js $<span class="token punctuation">(</span>filter<span class="token operator">-</span>out $@<span class="token punctuation">,</span>$<span class="token punctuation">(</span>MAKECMDGOALS<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>这后面的<code>$(filter-out $@,$(MAKECMDGOALS))</code>就是把命令行输入的参数直接传输给<code>node build/bin/new.js</code>，具体细节这里不展开，还是直接看看<code>build/bin/new.js</code>的具体细节。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 参数校验</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span><span class="token property-access">argv</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'[组件名]必填 - Please enter new component name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fileSave <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'file-save'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> uppercamelcase <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uppercamelcase'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取命令行的参数</span>
<span class="token comment">// e.g. node new.js input 输入框 </span>
<span class="token comment">// process.argv表示命令行的参数数组</span>
<span class="token comment">// 0是node，1是new.js，2和3就是后面两个参数</span>
<span class="token keyword">const</span> componentname <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token property-access">argv</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 组件名</span>
<span class="token keyword">const</span> chineseName <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token property-access">argv</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">||</span> componentname<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">ComponentName</span> <span class="token operator">=</span> <span class="token function">uppercamelcase</span><span class="token punctuation">(</span>componentname<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 转成驼峰表示</span>
<span class="token comment">// 组件所在的目录文件</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">PackagePath</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../packages'</span><span class="token punctuation">,</span> componentname<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 检查components.json中是否已经存在同名组件</span>
<span class="token keyword">const</span> componentsFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../components.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>componentsFile<span class="token punctuation">[</span>componentname<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 已存在.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token method function property-access">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// componentsFile中写入新的组件键值对</span>
componentsFile<span class="token punctuation">[</span>componentname<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./packages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token function">fileSave</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../components.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>componentsFile<span class="token punctuation">,</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token string">'  '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token keyword">const</span> <span class="token maybe-class-name">Files</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">index.js相关模板</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> 
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'src/main.vue'</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">组件相关的模板</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 下面三个文件是的对应的中英文api文档</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../examples/docs/zh-CN'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">## </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chineseName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../examples/docs/en-US'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">## </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../examples/docs/es'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">## </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../test/unit/specs'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.spec.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">组件相关测试用例的模板</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../packages/theme-chalk/src'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.scss</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">组件的样式文件</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'../../types'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.d.ts</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">组件的types文件，用于语法提示</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 生成组件必要的文件</span>
<span class="token maybe-class-name">Files</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">fileSave</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token maybe-class-name">PackagePath</span><span class="token punctuation">,</span> file<span class="token punctuation">.</span><span class="token property-access">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>这个脚本最终会在<code>components.json</code>写入组件相关的键值对，同时在packages目录创建对应的组件文件，并在<code>packages/theme-chalk/src</code>目录下创建一个样式文件，Element的样式是使用sass进行预编译的，所以生成是<code>.scss</code>文件。大致看下packages目录下生成的文件的模板：</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
  filename<span class="token operator">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  import </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> from './src/main';

  /* istanbul ignore next */
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.install = function(Vue) {
    Vue.component(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.name, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">);
  };

  export default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
  filename<span class="token operator">:</span> <span class="token string">'src/main.vue'</span><span class="token punctuation">,</span>
  content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  &lt;template>
    &lt;div class="el-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>componentname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/div>
  &lt;/template>

  &lt;script>
    export default {
      name: 'El</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">ComponentName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'
    };
  &lt;/script>
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>
</code></pre>
<p>每个组件都会对外单独暴露一个install方法，因为Element支持按需加载。同时，每个组件名都会加上<code>El</code>前缀。，所以我们使用Element组件时，经常是这样的<code>el-xxx</code>，这符合W3C的自定义HTML标签的<a href="https://www.w3.org/TR/custom-elements/#concepts">规范</a>（小写，并且包含一个短杠）。</p>
<h2 id="%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B">打包流程<a class="anchor" href="#%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B">§</a></h2>
<p>由于现代前端的复杂环境，代码写好之后并不能直接使用，被拆成模块的代码，需要通过打包工具进行打包成一个单独的js文件。并且由于各种浏览器的兼容性问题，还需要把ES6语法转译为ES5，sass、less等css预编译语言需要经过编译生成浏览器真正能够运行的css文件。所以，当我们通过<code>npm run new component</code>新建一个组件，并通过<code>npm run dev</code>在本地调试好代码后，需要把进行打包操作，才能真正发布到npm上。</p>
<p>这里运行<code>npm run dist</code>进行Element的打包操作，具体命令如下。</p>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"dist"</span><span class="token punctuation">:</span> "
    npm run clean <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    npm run build<span class="token punctuation">:</span>file <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    npm run lint <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>common<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>component<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    npm run build<span class="token punctuation">:</span>utils <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    npm run build<span class="token punctuation">:</span>umd <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    npm run build<span class="token punctuation">:</span>theme
"
</code></pre>
<p><img src="https://file.shenfq.com/18-9-14/30112392.jpg" alt="流程图"></p>
<p>下面一步步拆解上述流程。</p>
<h4 id="%E6%B8%85%E7%90%86%E6%96%87%E4%BB%B6">清理文件<a class="anchor" href="#%E6%B8%85%E7%90%86%E6%96%87%E4%BB%B6">§</a></h4>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"clean"</span><span class="token punctuation">:</span> <span class="token string">"rimraf lib &amp;&amp; rimraf packages/*/lib &amp;&amp; rimraf test/**/coverage"</span>
</code></pre>
<p>使用<code>npm run clean</code>会删除之前打包生成的文件，这里直接使用了一个node包：rimraf，类似于linux下的<code>rm -rf</code>。</p>
<h4 id="%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90">入口文件生成<a class="anchor" href="#%E5%85%A5%E5%8F%A3%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90">§</a></h4>
<p><code>npm run build:file</code>在前面已经介绍过了，通过components.json生成入口文件。</p>
<h4 id="%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5">代码检查<a class="anchor" href="#%E4%BB%A3%E7%A0%81%E6%A3%80%E6%9F%A5">§</a></h4>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"lint"</span><span class="token punctuation">:</span> <span class="token string">"eslint src/**/* test/**/* packages/**/* build/**/* --quiet"</span>
</code></pre>
<p>使用ESLint对多个目录下的文件进行lint操作。</p>
<h4 id="%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">文件打包<a class="anchor" href="#%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">§</a></h4>
<pre class="language-autoit"><code class="language-autoit">webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>common<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
webpack <span class="token operator">-</span><span class="token operator">-</span>config build<span class="token operator">/</span>webpack<span class="token punctuation">.</span>component<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
</code></pre>
<p>这里直接使用原生webpack进行打包操作，webpack版本为：3.7.1。在Element@2.4.0之前，使用的打包工具为<a href="https://github.com/ElemeFE/cooking/blob/master/README_zh-cn.md"><code>cooking</code></a>，但是这个工具是基于webpack2，很久没有更新（ps. 项目中能使用webpack最好使用webpack，多阅读官网的文档，虽然文档很烂，其他第三方对webpack进行包装的构建工具，很容易突然就不更新了，到时候要迁移会很麻烦）。</p>
<p>这三个配置文件的配置基本类似，区别在entry和output。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// webpack.conf.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    app<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/index.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'index.js'</span><span class="token punctuation">,</span>
    chunkFilename<span class="token operator">:</span> <span class="token string">'[id].js'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    library<span class="token operator">:</span> <span class="token string">'ELEMENT'</span><span class="token punctuation">,</span>
    umdNamedDefine<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// webpack.common.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    app<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/index.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'element-ui.common.js'</span><span class="token punctuation">,</span>
    chunkFilename<span class="token operator">:</span> <span class="token string">'[id].js'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// webpack.component.js</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">Components</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../components.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token maybe-class-name">Components</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
    chunkFilename<span class="token operator">:</span> <span class="token string">'[id].js'</span><span class="token punctuation">,</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>webpack.conf.js 与 webpack.common.js打包的入口文件都是<code>src/index.js</code>，该文件通过<code>npm run build:file</code>生成。不同之处在于输出文件，两个配置生成的js都在lib目录，重点在于libraryTarget，一个是umd，一个是commonjs2。还一个 webpack.component.js 的入口文件为 components.json 中的所有组件，表示packages目录下的所有组件都会在lib文件夹下生成也单独的js文件，这些组件单独的js文件就是用来做按需加载的，如果需要哪个组件，就会单独import这个组件js。</p>
<p>当我们直接在代码中引入整个Element的时候，加载的是 webpack.common.js 打包生成的 element-ui.common.js 文件。因为我们引入npm包的时候，会根据package.json中的main字段来查找入口文件。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token string">"main"</span><span class="token operator">:</span> <span class="token string">"lib/element-ui.common.js"</span>
</code></pre>
<h4 id="%E8%BD%AC%E8%AF%91%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95">转译工具方法<a class="anchor" href="#%E8%BD%AC%E8%AF%91%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95">§</a></h4>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"build:utils"</span><span class="token punctuation">:</span> <span class="token string">"cross-env BABEL_ENV=utils babel src --out-dir lib --ignore src/index.js"</span><span class="token punctuation">,</span>
</code></pre>
<p>这一部分是吧src目录下的除了index.js入口文件外的其他文件通过babel转译，然后移动到lib文件夹下。</p>
<pre class="language-autoit"><code class="language-autoit">└─src
    ├─directives
    ├─locale
    ├─mixins
    ├─transitions
    ├─popup
    └─index<span class="token punctuation">.</span>js
</code></pre>
<p>在src目录下，除了index.js外，还有一些其他文件夹，这些是Element组件中经常使用的工具方法。如果你对Element的源码足够熟悉，可以直接把Element中一些工具方法拿来使用，不再需要安装其他的包。</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'element-ui/lib/utils/date'</span><span class="token punctuation">)</span>

date<span class="token punctuation">.</span><span class="token method function property-access">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span> <span class="token string">'HH:mm:ss'</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="%E7%94%9F%E6%88%90%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6">生成样式文件<a class="anchor" href="#%E7%94%9F%E6%88%90%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6">§</a></h4>
<pre class="language-autoit"><code class="language-autoit"><span class="token string">"build:theme"</span><span class="token punctuation">:</span> "
  node build<span class="token operator">/</span>bin<span class="token operator">/</span>gen<span class="token operator">-</span>cssfile <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
  gulp build <span class="token operator">-</span><span class="token operator">-</span>gulpfile packages<span class="token operator">/</span>theme<span class="token operator">-</span>chalk<span class="token operator">/</span>gulpfile<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
  cp<span class="token operator">-</span>cli packages<span class="token operator">/</span>theme<span class="token operator">-</span>chalk<span class="token operator">/</span>lib lib<span class="token operator">/</span>theme<span class="token operator">-</span>chalk
"
</code></pre>
<p>这里直接使用gulp将scss文件转为css文件。</p>
<pre class="language-javascript"><code class="language-javascript">gulp<span class="token punctuation">.</span><span class="token method function property-access">src</span><span class="token punctuation">(</span><span class="token string">'./src/*.scss'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>sass<span class="token punctuation">.</span><span class="token method function property-access">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">autoprefixer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      browsers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ie > 9'</span><span class="token punctuation">,</span> <span class="token string">'last 2 versions'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      cascade<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">cssmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token method function property-access">dest</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>最终我们引入的<code>element-ui/lib/theme-chalk/index.css</code>，其源文件只不过是把所有组件的scss文件进行import。这个index.scss是在运行gulp之前，通过<code>node build/bin/gen-cssfile</code>命令生成的，逻辑与生成js的入口文件类似，同样是遍历components.json。</p>
<p><img src="https://file.shenfq.com/18-9-16/48946057.jpg" alt="index.scss"></p>
<h2 id="%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B">发布流程<a class="anchor" href="#%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B">§</a></h2>
<p>代码经过之前的编译，就到了发布流程，在Element中发布主要是用shell脚本实现的。Element发布一共涉及三个部分。</p>
<ol>
<li>git发布</li>
<li>npm发布</li>
<li>官网发布</li>
</ol>
<pre class="language-autoit"><code class="language-autoit"><span class="token operator">/</span><span class="token operator">/</span> 新版本发布
<span class="token string">"pub"</span><span class="token punctuation">:</span> "
    npm run bootstrap <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    sh build<span class="token operator">/</span>git<span class="token operator">-</span>release<span class="token punctuation">.</span>sh <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    sh build<span class="token operator">/</span>release<span class="token punctuation">.</span>sh <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    node build<span class="token operator">/</span>bin<span class="token operator">/</span>gen<span class="token operator">-</span>indices<span class="token punctuation">.</span>js <span class="token operator">&amp;</span><span class="token operator">&amp;</span> 
    sh build<span class="token operator">/</span>deploy<span class="token operator">-</span>faas<span class="token punctuation">.</span>sh
"
</code></pre>
<h4 id="git%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B">git冲突检测<a class="anchor" href="#git%E5%86%B2%E7%AA%81%E6%A3%80%E6%B5%8B">§</a></h4>
<p>运行 <a href="http://git-release.sh">git-release.sh</a> 进行git冲突的检测，这里主要是检测dev分支是否冲突，因为Element是在dev分支进行开发的（这个才Element官方的开发指南也有提到），只有在最后发布时，才merge到master。</p>
<p><img src="https://file.shenfq.com/18-9-16/41638093.jpg" alt="开发指南"></p>
<pre class="language-bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env sh</span>
<span class="token comment"># 切换至dev分支</span>
<span class="token function">git</span> checkout dev

<span class="token comment"># 检测本地和暂存区是否还有未提交的文件</span>
<span class="token keyword">if</span> <span class="token builtin class-name">test</span> -n <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> status --porcelain<span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">'Unclean working tree. Commit or stash changes first.'</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
  <span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>
<span class="token comment"># 检测本地分支是否有误</span>
<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">git</span> fetch --quiet <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">'There was a problem fetching your branch. Run <span class="token variable"><span class="token variable">`</span><span class="token function">git</span> fetch<span class="token variable">`</span></span> to see more...'</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
  <span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>
<span class="token comment"># 检测本地分支是否落后远程分支</span>
<span class="token keyword">if</span> <span class="token builtin class-name">test</span> <span class="token string">"0"</span> <span class="token operator">!=</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">git</span> rev-list --count --left-only @<span class="token string">'{u}'</span><span class="token punctuation">..</span>.HEAD<span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token builtin class-name">echo</span> <span class="token string">'Remote history differ. Please pull changes.'</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
  <span class="token builtin class-name">exit</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">'No conflicts.'</span> <span class="token operator">></span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="git%E5%8F%91%E5%B8%83npm%E5%8F%91%E5%B8%83">git发布；npm发布<a class="anchor" href="#git%E5%8F%91%E5%B8%83npm%E5%8F%91%E5%B8%83">§</a></h4>
<p>检测到git在dev分支上没有冲突后，<a href="http://xn--release-zx2ll52i774ctb5a.sh">立即执行release.sh</a>。</p>
<p><img src="https://file.shenfq.com/18-9-17/55012829.jpg" alt="发布"></p>
<p>这一部分代码比较简单，可以直接在<a href="https://github.com/ElemeFE/element/blob/dev/build/release.sh">github</a>上查看。上述发布流程，省略了一个部分，就是Element会将其样式也发布到<a href="https://www.npmjs.com/package/element-theme-chalk">npm</a>上。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># publish theme</span>
<span class="token builtin class-name">echo</span> <span class="token string">"Releasing theme-chalk <span class="token variable">$VERSION</span> ..."</span>
<span class="token builtin class-name">cd</span> packages/theme-chalk
<span class="token function">npm</span> version <span class="token variable">$VERSION</span> --message <span class="token string">"[release] <span class="token variable">$VERSION</span>"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$VERSION</span> <span class="token operator">=</span>~ <span class="token string">"beta"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">then</span>
  <span class="token function">npm</span> publish --tag beta
<span class="token keyword">else</span>
  <span class="token function">npm</span> publish
<span class="token keyword">fi</span>
</code></pre>
<p>如果你只想使用Element的样式，不使用它的Vue组件，你也可以直接在npm上下载他们的样式，不过一般也没人这么做吧。</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> -S element-theme-chalk
</code></pre>
<h4 id="%E5%AE%98%E7%BD%91%E6%9B%B4%E6%96%B0">官网更新<a class="anchor" href="#%E5%AE%98%E7%BD%91%E6%9B%B4%E6%96%B0">§</a></h4>
<p>这一步就不详细说了，因为不在文章想说的构建流程之列。</p>
<p>大致就是将静态资源生成到<code>examples/element-ui</code>目录下，然后放到<code>gh-pages</code>分支，这样就能通过github pages的方式访问。不信，你访问试试。</p>
<blockquote>
<p><a href="http://elemefe.github.io/element">http://elemefe.github.io/element</a></p>
</blockquote>
<p>同时在该分支下，写入了CNAME文件，这样访问<a href="element.eleme.io">element.eleme.io</a>也能定向到element的github pages了。</p>
<pre class="language-autoit"><code class="language-autoit">echo element<span class="token punctuation">.</span>eleme<span class="token punctuation">.</span>io<span class="token operator">></span><span class="token operator">></span>examples<span class="token operator">/</span>element<span class="token operator">-</span>ui<span class="token operator">/</span>CNAME
</code></pre>
<p><img src="https://file.shenfq.com/18-9-17/84798170.jpg" alt="域名重定向"></p>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>Element的代码总体看下来，还是十分流畅的，对自己做组件化帮助很大。刚开始写这篇文章的时候，标题写着<code>主流组件库的构建流程</code>，想把Element和antd的构建流程都写出来，写完Element才发现这个坑开得好大，于是麻溜的把标题改成<code>Element的构建流程</code>。当然Element除了其构建流程，本身很多组件的实现思路也很优雅，大家感兴趣可以去看一看。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>