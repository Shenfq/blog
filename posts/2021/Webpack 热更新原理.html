<!doctype html><html class="" data-reactroot=""><head><script src="/assets/hm.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">Webpack 热更新原理 · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0">如何配置热更新</a><ol></ol></li><li><a href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8E%9F%E7%90%86">热更新的原理</a><ol><li><a href="#webpack-%E6%89%93%E5%8C%85%E9%80%BB%E8%BE%91">webpack 打包逻辑</a></li><li><a href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%AE%9E%E7%8E%B0">热更新的实现</a><ol></ol></li><li><a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">完整代码</a></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><h1>Webpack 热更新原理</h1><div class="main_post_meta"><time dateTime="2021/07/21">2021-07-21</time> · <!-- -->shenfq</div><article><p>用过 webpack 的同学应该都知道，有一个特别好用的『热更新』，在不刷新页面的情况下，就能将代码推到浏览器。</p>
<p><img src="https://file.shenfq.com/pic/20210718124656.gif" alt="热更新"></p>
<p>今天的文章将会探寻一下 webpack 热更新的秘密。</p>
<h2 id="%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0">如何配置热更新<a class="anchor" href="#%E5%A6%82%E4%BD%95%E9%85%8D%E7%BD%AE%E7%83%AD%E6%9B%B4%E6%96%B0">§</a></h2>
<p>我们先安装一些我们需要的包：</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> i webpack webpack-cli -D
<span class="token function">npm</span> i webpack-dev-server -D
<span class="token function">npm</span> i html-webpack-plugin -D
</code></pre>
<p>然后，我们需要弄明白，webpack 从版本 webpack@4 之后，需要通过 webpack CLI 来启动服务，提供了打包的命令和启动开发服务的命令。</p>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># 打包到指定目录</span>
webpack build --mode production --config webpack.config.js
<span class="token comment"># 启动开发服务器</span>
webpack serve --mode development --config webpack.config.js
</code></pre>
<pre class="language-json"><code class="language-json"><span class="token comment">// pkg.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"webpack serve --mode development --config webpack.config.js"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"webpack build --mode production --config webpack.config.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"^5.45.1"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-cli"</span><span class="token operator">:</span> <span class="token string">"^4.7.2"</span><span class="token punctuation">,</span>
    <span class="token property">"webpack-dev-server"</span><span class="token operator">:</span> <span class="token string">"^3.11.2"</span><span class="token punctuation">,</span>
    <span class="token property">"html-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^5.3.2"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在启动开发服务的时候，在 webpack 的配置文件中配置 <code>devServe</code> 属性，即可开启热更新模式。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">HtmlWebpackPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'main.js'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    hot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启热更新</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token comment">// 指定服务器端口号</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token string">'./index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<p>配置完毕后，我们可以开始按下面的目录结构新建文件。</p>
<pre class="language-bash"><code class="language-bash">├── src
│   ├── index.js
│   └── num.js
├── index.html
├── package.json
└── webpack.config.js
</code></pre>
<p>这里因为需要对 DOM 进行操作，为了方便我们直接使用 jQuery （yyds），在 HTML 文件中引入 jQuery 的 CDN。</p>
<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Webpack Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><a class="token url-link" href="https://unpkg.com/jquery@3.6.0/dist/jquery.js">https://unpkg.com/jquery@3.6.0/dist/jquery.js</a><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
</code></pre>
<p>然后在 <code>index.js</code> 中对 <code>div#app</code> 进行操作。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// src/index.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> setNum <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./num'</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> $app <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
  $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    num <span class="token operator">=</span> <span class="token function">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token comment">// 调用 setNum 更新 num 的值</span>
    $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1e3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>这里每秒调用一次 <code>setNum</code> 方法，更新变量 <code>num</code> 的值，然后修改 <code>div#app</code> 的文本。<code>setNum</code> 方法在 <code>num.js</code> 文件中，这里就是我们需要修改的地方，通过修改该方法，让页面直接进行热更新。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// src/num.js</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">setNum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">++</span>num <span class="token comment">// 让 num 自增</span>
<span class="token punctuation">}</span>
</code></pre>
<p>修改 <code>setNum</code> 方法的过程中，发现页面直接刷新了，并没有达到预想中的热更新操作。</p>
<p><img src="https://file.shenfq.com/pic/20210718123529.gif" alt=""></p>
<p><a href="https://webpack.docschina.org/configuration/dev-server/#devserverhot">官方文档</a>中好像也没说还有什么其他的配置要做，真是让人迷惑。</p>
<p><img src="https://file.shenfq.com/pic/20210718124125.png" alt=""></p>
<p>最后把文档翻烂了之后，发现，热更新除了要修改 <code>devServer</code> 配置之外，还需要在代码中告诉 webpack 哪些模块是需要进行热更新的。</p>
<blockquote>
<p>模块热替换：<a href="https://webpack.docschina.org/guides/hot-module-replacement/">https://webpack.docschina.org/guides/hot-module-replacement/</a></p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/20210718124349.png" alt="webpack 文档"></p>
<p>同理，我们需要修改 <code>src/index.js</code>，告诉 webpack <code>src/num.js</code> 模块是需要进行热更新的。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> setNum <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./num'</span>

<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//num 模块需要进行热更新</span>
  module<span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">accept</span><span class="token punctuation">(</span><span class="token string">'./num'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ……
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/20210718124656.gif" alt="热更新"></p>
<p>关于模块热替换更多 API 介绍可以看这里：</p>
<blockquote>
<p><a href="https://www.webpackjs.com/api/hot-module-replacement">模块热替换(hot module replacement) -https://www.webpackjs.com/api/hot-module-replacement</a></p>
</blockquote>
<p>如果不是像我这样手动配置 webpack，并且使用 jQuery 根本不会注意到这个配置。在一些 Loader （style-loader、vue-loader、react-hot-loader）中，都在其内部调用了 module hot api，也是替开发者省了很多心。</p>
<h4 id="style-loader-%E7%83%AD%E6%9B%B4%E6%96%B0%E4%BB%A3%E7%A0%81">style-loader 热更新代码<a class="anchor" href="#style-loader-%E7%83%AD%E6%9B%B4%E6%96%B0%E4%BB%A3%E7%A0%81">§</a></h4>
<blockquote>
<p><a href="https://github.com/webpack-contrib/style-loader/blob/6e70da0c5a37025510afe4f49ddeaf6c39daaa75/src/utils.js#L175">https://github.com/webpack-contrib/style-loader/blob/6e70da0c5a37025510afe4f49ddeaf6c39daaa75/src/utils.js#L175</a></p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/20210718130555.png" alt=""></p>
<h4 id="vue-loader-%E7%83%AD%E6%9B%B4%E6%96%B0%E4%BB%A3%E7%A0%81">vue-loader 热更新代码<a class="anchor" href="#vue-loader-%E7%83%AD%E6%9B%B4%E6%96%B0%E4%BB%A3%E7%A0%81">§</a></h4>
<blockquote>
<p><a href="https://github.com/vuejs/vue-loader/blob/689075d763994a536022ea31348186f0a2c27460/lib/codegen/hotReload.js#L17">https://github.com/vuejs/vue-loader/blob/689075d763994a536022ea31348186f0a2c27460/lib/codegen/hotReload.js#L17</a></p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/20210718130802.png" alt=""></p>
<h2 id="%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8E%9F%E7%90%86">热更新的原理<a class="anchor" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8E%9F%E7%90%86">§</a></h2>
<p>在讲热更新之前，我们需要先看看 webpack 是如何打包文件的。</p>
<h3 id="webpack-%E6%89%93%E5%8C%85%E9%80%BB%E8%BE%91">webpack 打包逻辑<a class="anchor" href="#webpack-%E6%89%93%E5%8C%85%E9%80%BB%E8%BE%91">§</a></h3>
<p>先回顾一下前面的代码，并且把之前的 ESM 语法改成 <code>require</code> ，因为 webpack 内部也会把 ESM 修改成 <code>require</code>。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// src/index.js</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">const</span> $app <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
  $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    num <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./num'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1e3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// src/num.js</span>
exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setNum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">--</span>num
<span class="token punctuation">}</span>
</code></pre>
<p>我们都知道，webpack 本质是一个打包工具，会把多个 js 文件打包成一个 js 文件。下面的代码是 webpack 打包后的代码：</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// webpackBootstrap</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 所有模块打包都一个对象中</span>
  <span class="token comment">// key 为文件名，value 为一个匿名函数，函数内就是文件内代码</span>
  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"./src/index.js"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token string">"use strict"</span><span class="token punctuation">;</span>
      <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">const</span> $app <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
        $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/num.js"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">setNum</span><span class="token punctuation">)</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
          $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1e3</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token string">"./src/num.js"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token string">"use strict"</span><span class="token punctuation">;</span>
      <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span>__webpack_exports__<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"setNum"</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">return</span> <span class="token operator">++</span>num
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 内部实现一个 require 方法</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Execute the module function</span>
    <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
        id<span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
        exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">// 取出模块执行</span>
      <span class="token keyword">var</span> factory <span class="token operator">=</span> __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span>
      factory<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">,</span> __webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      module<span class="token punctuation">.</span><span class="token property-access">error</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
      <span class="token keyword control-flow">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回执行后的 exports</span>
    <span class="token keyword control-flow">return</span> module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/*******************************************/</span>
  <span class="token comment">// 启动</span>
  <span class="token comment">// Load entry module and return exports</span>
  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token string">"./src/index.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>当然，上面的代码是简化后的代码，webpack 实际打包出来的代码还会有一些缓存、容错以及 ESM 模块兼容之类的代码。</p>
<p>我们可以简单的模拟一下 webpack 的打包逻辑。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// build.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> minimist <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'minimist'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chokidar'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">wrapperFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function (require, module, exports) {\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token punctuation">.</span><span class="token method function property-access">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'\n  '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n}</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">modulesFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">files<span class="token punctuation">,</span> contents</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> modules <span class="token operator">=</span> <span class="token string">'const modules = {\n'</span>
  files<span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    modules <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">": </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">wrapperFn</span><span class="token punctuation">(</span>contents<span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,\n\n</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  modules <span class="token operator">+=</span> <span class="token string">'}'</span>
  <span class="token keyword control-flow">return</span> modules
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">requireFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">const require = function(url) {
  const module = { exports: {} }
  const factory = modules[url] || function() {}
  factory.call(module, require, module, module.exports)
  return module.exports
}</span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token punctuation">{</span>
  wrapperFn<span class="token punctuation">,</span>
  modulesFn<span class="token punctuation">,</span>
  requireFn<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Build</span> <span class="token punctuation">{</span>
  files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  contents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 解析参数</span>
    <span class="token comment">// index: 入口 html 的模板</span>
    <span class="token comment">// entry: 打包的入口 js 文件名</span>
    <span class="token comment">// output: 打包后输出的 js 文件名</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">minimist</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token property-access">argv</span><span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> index<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> output <span class="token punctuation">}</span> <span class="token operator">=</span> args

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">index</span> <span class="token operator">=</span> index <span class="token operator">||</span> <span class="token string">'index.html'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">entry</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">output</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">getScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">getScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从入口的 js 文件开始，获取所有的依赖</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">entry</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">dirname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> newContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">processJS</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> newContent
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">processJS</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> match <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> content
    <span class="token keyword">const</span> depReg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">require\s*\(['"](.+)['"]\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>

    <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> depReg<span class="token punctuation">.</span><span class="token method function property-access">exec</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>statements<span class="token punctuation">,</span> url<span class="token punctuation">]</span> <span class="token operator">=</span> match
      <span class="token keyword">let</span> newUrl <span class="token operator">=</span> url
      <span class="token comment">// 不存在文件后缀时，手动补充后缀</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newUrl<span class="token punctuation">.</span><span class="token method function property-access">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newUrl <span class="token operator">+=</span> <span class="token string">'.js'</span>
      <span class="token punctuation">}</span>

      newUrl <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> newUrl<span class="token punctuation">)</span>
      <span class="token comment">// 将 require 中的相对地址替换为绝对地址</span>
      <span class="token keyword">let</span> newRequire <span class="token operator">=</span> statements<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> newUrl<span class="token punctuation">)</span>
      newRequire <span class="token operator">=</span> newRequire<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(/* </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> */</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      result <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span>statements<span class="token punctuation">,</span> newRequire<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>newUrl<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword control-flow">return</span> result
  <span class="token punctuation">}</span>

  <span class="token function">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> outputJS <span class="token operator">=</span> <span class="token string">''</span>
    outputJS <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* all modules */</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token punctuation">.</span><span class="token method function property-access">modulesFn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span>
    outputJS <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* require */</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>template<span class="token punctuation">.</span><span class="token method function property-access">requireFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span>
    outputJS <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* start */require('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">entry</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')\n</span><span class="token template-punctuation string">`</span></span>

    <span class="token keyword control-flow">return</span> outputJS
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span>
cosnt fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">Build</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 生成打包后的代码</span>
<span class="token keyword">const</span> code <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token method function property-access">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fs<span class="token punctuation">.</span><span class="token method function property-access">writeFileSync</span><span class="token punctuation">(</span>build<span class="token punctuation">.</span><span class="token property-access">output</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span>
</code></pre>
<p>启动代码：</p>
<pre class="language-bash"><code class="language-bash">node index.js --entry ./src/index.js --output main.js
</code></pre>
<p>生成后的代码如下所示：</p>
<pre class="language-js"><code class="language-js"><span class="token comment">/*
	所有的模块都会放到一个对象中。
	对象的 key 为模块的文件路径；
	对象的 value 为一个匿名函数；
*/</span>
<span class="token keyword">const</span> modules <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">"src/index.js"</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token keyword">const</span> $app <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
      $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        num <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./num'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setNum</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
        $app<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">同步修改结果: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>num<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1e3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token string">"src/num.js"</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    exports<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setNum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">num</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token operator">++</span>num
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 
	内部实现一个 require 方法，从 modules 中获取对应模块，
	然后注入 require、module、exports 等参数
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">require</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">{</span> exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> factory <span class="token operator">=</span> modules<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  factory<span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> require<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span><span class="token property-access">exports</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> module<span class="token punctuation">.</span><span class="token property-access">exports</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 启动入口的 index.js */</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'src/index.js'</span><span class="token punctuation">)</span>
</code></pre>
<p>webpack 打包除了将所有 js 模块打包到一个文件外，引入 <code>html-webpack-plugin</code> 插件，还会将生成的 output 自动插入到 html 中。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  template<span class="token operator">:</span> <span class="token string">'./index.html'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>这里我们也在 <code>build.js</code> 中新增一个方法，模拟下这个行为。</p>
<pre class="language-js"><code class="language-js">module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Build</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……
  <span class="token punctuation">}</span>
  <span class="token function">genIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> index<span class="token punctuation">,</span> output <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> htmlStr <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> insertIdx <span class="token operator">=</span> htmlStr<span class="token punctuation">.</span><span class="token method function property-access">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;/head>'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> insertScript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/script></span><span class="token template-punctuation string">`</span></span>
    <span class="token comment">// 在 head 标签内插入 srcript 标签</span>
    <span class="token keyword control-flow">return</span> htmlStr<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> insertIdx<span class="token punctuation">)</span> <span class="token operator">+</span> insertScript <span class="token operator">+</span> htmlStr<span class="token punctuation">.</span><span class="token method function property-access">slice</span><span class="token punctuation">(</span>insertIdx<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>要完成热更新，webpack 还需要自己启动一个服务，完成静态文件的传输。我们利用 koa 启动一个简单的服务。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span>
<span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> nodePath <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Build</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 启动服务</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> ctx
  <span class="token keyword">const</span> file <span class="token operator">=</span> nodePath<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span> 
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回 html</span>
      ctx<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span>
        <span class="token string">'Content-Type'</span><span class="token punctuation">,</span>
        <span class="token string">'text/html;charset=utf-8'</span>
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token method function property-access">genIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword control-flow">return</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>file <span class="token operator">===</span> build<span class="token punctuation">.</span><span class="token property-access">output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span>
        <span class="token string">'Content-Type'</span><span class="token punctuation">,</span>
        <span class="token string">'application/x-javascript;charset=utf-8'</span>
      <span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token method function property-access">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword control-flow">return</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token keyword control-flow">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Not Found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre>
<p>启动服务后，可以看到页面正常运行。</p>
<pre class="language-bash"><code class="language-bash">node index.js --entry ./src/index.js --output main.js
</code></pre>
<p><img src="https://file.shenfq.com/pic/20210721144652.gif" alt=""></p>
<h3 id="%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%AE%9E%E7%8E%B0">热更新的实现<a class="anchor" href="#%E7%83%AD%E6%9B%B4%E6%96%B0%E7%9A%84%E5%AE%9E%E7%8E%B0">§</a></h3>
<p>webpack 在热更新模式下，启动服务后，服务端会与客户端建立一个长链接。文件修改后，服务端会通过长链接向客户端推送一条消息，客户端收到后，会重新请求一个 js 文件，返回的 js 文件会调用 <code>webpackHotUpdatehmr</code> 方法，用于替换掉 <code>__webpack_modules__</code> 中的部分代码。</p>
<p><img src="https://file.shenfq.com/pic/20210721151932.gif" alt=""></p>
<p><img src="https://file.shenfq.com/pic/20210721153620.png" alt=""></p>
<p>通过实验可以看到，热更新的具体流程如下：</p>
<ol>
<li>Webpack Server 与 Client 建立长链接；</li>
<li>Webpack 监听文件修改，修改后通过长链接通知客户端；</li>
<li>Client 重新请求文件，替换 <code>__webpack_modules__</code> 中对应部分；</li>
</ol>
<h4 id="%E5%BB%BA%E7%AB%8B%E9%95%BF%E9%93%BE%E6%8E%A5">建立长链接<a class="anchor" href="#%E5%BB%BA%E7%AB%8B%E9%95%BF%E9%93%BE%E6%8E%A5">§</a></h4>
<p>Server 与 Client 之间需要建立长链接，可以直接使用开源方案的 <a href="http://socket.io">socket.io</a> 的方案。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span>
<span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> koaSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-socket-2'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Build</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koaSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

socket<span class="token punctuation">.</span><span class="token method function property-access">attach</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token comment">// 启动长链接服务</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  ………
<span class="token punctuation">}</span>
……

<span class="token comment">// build.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Build</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……
  <span class="token punctuation">}</span>
  <span class="token function">genIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……
    <span class="token comment">// 新增 socket.io 客户端代码</span>
    <span class="token keyword">const</span> insertScript <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;script src="/socket.io/socket.io.js">&lt;/script>
    &lt;script src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">">&lt;/script>
    </span><span class="token template-punctuation string">`</span></span>
    ……
  <span class="token punctuation">}</span>
  <span class="token function">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> outputJS <span class="token operator">=</span> <span class="token string">''</span>
    ……
    <span class="token comment">// 新增代码，监听服务端推送的消息</span>
    outputJS <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* socket */
    const socket = io()
    socket.on('updateMsg', function (msg){
    // 监听服务端推送的消息
    })\n</span><span class="token template-punctuation string">`</span></span>
    ……
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="%E7%9B%91%E5%90%AC%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9">监听文件修改<a class="anchor" href="#%E7%9B%91%E5%90%AC%E6%96%87%E4%BB%B6%E4%BF%AE%E6%94%B9">§</a></h4>
<p>前面实现 <code>build.js</code> 的时候，通过 <code>getScript()</code> 方法，已经收集了所有的依赖文件。这里只需要通过 <code>chokidar</code> 监听所有的依赖文件即可。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// build.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Build</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">onUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ……
    <span class="token comment">// 获取所有js依赖</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">getScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 开启文件监听</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">startWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听所有的依赖文件</span>
    chokidar<span class="token punctuation">.</span><span class="token method function property-access">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token spread operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">files</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取更新后的文件</span>
      <span class="token keyword">const</span> dir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">dirname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> newContent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">processJS</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
      <span class="token comment">// 将更新的文件写入内存</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">[</span>file<span class="token punctuation">]</span> <span class="token operator">=</span> newContent
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onUpdate</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">onUpdate</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">onWatch</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onUpdate</span> <span class="token operator">=</span> callback
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>在文件修改后，重写了 <code>build.contents</code> 中的文本内容，然后会触发 <code>onUpdate</code> 方法。所以，我们启动服务时，需要把实现这个方法，每次触发更新的时候，需要向客户端进行消息推送。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// index.js</span>
<span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> koaSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-socket-2'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Build</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./build'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">koaSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 启动长链接服务</span>
socket<span class="token punctuation">.</span><span class="token method function property-access">attach</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment">// 文件修改后，向所有的客户端广播修改的文件名</span>
build<span class="token punctuation">.</span><span class="token method function property-access">onWatch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token property-access">_io</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'updateMsg'</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span> file
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="%E8%AF%B7%E6%B1%82%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%9D%97">请求更新模块<a class="anchor" href="#%E8%AF%B7%E6%B1%82%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%9D%97">§</a></h4>
<p>客户端收到消息后，请求需要更新的模块。</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// build.js</span>
module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Build</span> <span class="token punctuation">{</span>
  <span class="token function">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> outputJS <span class="token operator">=</span> <span class="token string">''</span>
    ……
    <span class="token comment">// 新增代码，监听服务端推送的消息</span>
    outputJS <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* socket */
    const socket = io()
    socket.on('updateMsg', function (msg){
    	const json = JSON.parse(msg)
      if (json.type === 'update') {
        // 根据文件名，请求更新的模块
        fetch('/update/'+json.file)
          .then(rsp => rsp.text())
					.then(text => {
            eval(text) // 执行模块
          })
      }
    })\n</span><span class="token template-punctuation string">`</span></span>
    ……
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>然后在服务端中间件内处理 <code>/update/</code> 相关的请求。</p>
<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> method<span class="token punctuation">,</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> ctx
  
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回 html</span>
      ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token method function property-access">genIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword control-flow">return</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>nodePath<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token operator">===</span> build<span class="token punctuation">.</span><span class="token property-access">output</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回打包后的代码</span>
      ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token method function property-access">genCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword control-flow">return</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'/update/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> file <span class="token operator">=</span> nodePath<span class="token punctuation">.</span><span class="token method function property-access">relative</span><span class="token punctuation">(</span><span class="token string">'/update/'</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
      <span class="token keyword">const</span> content <span class="token operator">=</span> build<span class="token punctuation">.</span><span class="token property-access">contents</span><span class="token punctuation">[</span>file<span class="token punctuation">]</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 替换 modules 内的文件</span>
        ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">modules['</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>file<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'] = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
        	template<span class="token punctuation">.</span><span class="token method function property-access">wrapperFn</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
      	<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword control-flow">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最终效果：</p>
<p><img src="https://file.shenfq.com/pic/20210721163140.gif" alt=""></p>
<h3 id="%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">完整代码<a class="anchor" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81">§</a></h3>
<blockquote>
<p><a href="https://github.com/Shenfq/hmr">👉 Shenfq/hrm</a></p>
<p><a href="https://github.com/Shenfq/hmr">🔗 https://github.com/Shenfq/hmr</a></p>
</blockquote>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>这次自己凭感觉实现了一把 HMR，肯定和 Webpack 真实的 HMR 还是有一点出入，但是对于理解 HMR 的原理还是有一点帮助的，希望大家阅读文章后有所收获。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>