<!doctype html><html class="" data-reactroot=""><head><script src="/assets/hm.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="å‰ç«¯å·¥ç¨‹å¸ˆï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œè‡ªç„¶é†’çš„ç¬”è®°æœ¬ã€"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">ä»‹ç»ä¸€ä¸ªè¯·æ±‚åº“ â€” Undici Â· è‡ªç„¶é†’çš„åšå®¢</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">è‡ªç„¶é†’çš„åšå®¢</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">è‡ªç„¶é†’çš„åšå®¢</a></h1><p class="description">å‰ç«¯å·¥ç¨‹å¸ˆï¼Œçˆ±æŠ˜è…¾ï¼Œæ“…é•¿ JavaScriptï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œè‡ªç„¶é†’çš„ç¬”è®°æœ¬ã€</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>é¦–é¡µ</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>åˆ†ç±»</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>æ ‡ç­¾</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>å…³äº</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>å½’æ¡£</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>å‹æƒ…é“¾æ¥</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></li><li><a href="#%E4%B8%8A%E6%89%8B">ä¸Šæ‰‹</a><ol><li><a href="#undicifetch">undici.fetch</a></li><li><a href="#undicirequest">undici.request</a><ol></ol></li><li><a href="#undicisteam">undici.steam</a><ol></ol></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li></ol></nav></aside><section class="main"><div class="main_post_meta"><time dateTime="2021/10/19">2021-10-19</time> Â· <!-- -->shenfq</div><article><h2 id="%E5%89%8D%E8%A8%80">å‰è¨€<a class="anchor" href="#%E5%89%8D%E8%A8%80">Â§</a></h2>
<p>åœ¨æµè§ˆå™¨ä¸­ï¼Œå¦‚æœæƒ³å‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬ä»¥å‰ä¼šä½¿ç”¨åˆ° <code>xhr</code>ï¼Œä¸è¿‡è¿™ç§åº•å±‚ apiï¼Œå¾€å¾€è°ƒç”¨æ–¹å¼æ¯”è¾ƒç®€é™‹ã€‚ä¸ºäº†æé«˜å¼€å‘æ•ˆç‡ï¼Œ jQuery çš„ <code>$.ajax</code> å¯èƒ½æ˜¯æœ€å¥½çš„é€‰æ‹©ï¼Œå¥½åœ¨åæ¥å‡ºç°äº†æ›´åŠ ç°ä»£åŒ–çš„ <code>fetch</code> api ã€‚</p>
<p>ä½†æ˜¯è€ƒè™‘åˆ° <code>fetch</code> çš„å…¼å®¹æ€§ï¼Œè€Œä¸”å®ƒä¹Ÿä¸æ”¯æŒä¸€äº›å…¨å±€æ€§çš„é…ç½®ï¼Œä»¥åŠè¯·æ±‚ä¸­æ–­ï¼Œåœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”¨åˆ° <code>axios</code> è¯·æ±‚åº“ï¼Œæ¥è¿›è¡Œä¸€äº›è¯·æ±‚ã€‚åˆ°äº† Node.js ä¸­ï¼Œå‡ ä¹éƒ½ä¼šé€šè¿‡ <code>request</code> è¿™ä¸ªåº“ï¼Œæ¥è¿›è¡Œè¯·æ±‚ã€‚é—æ†¾çš„æ˜¯ï¼Œ<code>request</code> åœ¨ä¸¤å¹´å‰å°±åœæ­¢ç»´æŠ¤äº†ï¼Œåœ¨ Node.js ä¸­éœ€è¦æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿæ›¿ä»£çš„åº“è¿˜æŒºä¸å®¹æ˜“çš„ã€‚</p>
<p><img src="https://file.shenfq.com/pic/202110081517709.png" alt=""></p>
<p>åœ¨ request çš„ <a href="https://github.com/request/request/issues/3143">issues</a> ä¸­ï¼Œæœ‰ä¸€ä¸ªè¡¨æ ¼æ¨èäº†ä¸€äº›åœ¨ Node.js ä¸­å¸¸ç”¨çš„è¯·æ±‚åº“ï¼š</p>
<div class="table_wrapper"><table>
<thead>
<tr>
<th>åŒ…å</th>
<th>åŒ…å¤§å°</th>
<th>APIé£æ ¼</th>
<th>ç®€ä»‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.npmjs.com/package/node-fetch">node-fetch</a></td>
<td>0.4kb</td>
<td>promise / stream</td>
<td>A light-weight module that brings window.fetch to Node.js</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/got">got</a></td>
<td>48.4kb</td>
<td>promise / stream</td>
<td>Simplified HTTP requests</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/axios">axios</a></td>
<td>11.9kb</td>
<td>promise / stream</td>
<td>Promise based HTTP client for the browser and node.js</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/superagent">superagent</a></td>
<td>18kb</td>
<td>chaining / promise</td>
<td>Small progressive client-side HTTP request library, and Node.js module with the same API, sporting many high-level HTTP client features</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/urllib">urllib</a></td>
<td>816kb</td>
<td>callback / promise</td>
<td>Help in opening URLs (mostly HTTP) in a complex world â€” basic and digest authentication, redirections, cookies and more.</td>
</tr>
</tbody>
</table></div>
<p>æµè§ˆå™¨ä¸­ä½¿ç”¨æ¯”è¾ƒå¤šçš„ <code>axios</code>ï¼Œåœ¨ Node.js ä¸­å¹¶ä¸å¥½ç”¨ï¼Œç‰¹åˆ«æ˜¯è¦è¿›è¡Œæ–‡ä»¶ä¸Šä¼ çš„æ—¶å€™ï¼Œä¼šæœ‰å¾ˆå¤šæ„æƒ³ä¸åˆ°çš„é—®é¢˜ã€‚</p>
<p>æœ€è¿‘æˆ‘åœ¨ç½‘ä¸ŠğŸ„ğŸ¿çš„æ—¶å€™ï¼Œå‘ç° Node.js å®˜æ–¹æ˜¯æœ‰ä¸€ä¸ªè¯·æ±‚åº“çš„ï¼š<code>undici</code>ï¼Œåå­—å–å¾—è¿˜æŒºå¤æ‚çš„ã€‚æ‰€ä»¥ï¼Œä»Šå¤©çš„æ–‡ç« å°±æ¥ä»‹ç»ä¸€ä¸‹ <code>undici</code>ã€‚é¡ºä¾¿æä¸€å¥ï¼Œ<code>undici</code> æ˜¯æ„å¤§åˆ©è¯­ <code>11</code> çš„æ„æ€ï¼Œå¥½åƒåŒåä¸€ä¹Ÿå¿«åˆ°äº†ï¼Œåˆ©å¥½èŒ…å°ğŸ¤”ã€‚</p>
<blockquote>
<p>Undici means eleven in Italian. 1.1 -&gt; 11 -&gt; Eleven -&gt; Undici. It is also a Stranger Things reference.</p>
</blockquote>
<h2 id="%E4%B8%8A%E6%89%8B">ä¸Šæ‰‹<a class="anchor" href="#%E4%B8%8A%E6%89%8B">Â§</a></h2>
<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ <code>npm</code> æ¥å®‰è£… <code>undici</code>ï¼š</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> undici -S
</code></pre>
<p><code>undici</code> å¯¹å¤–æš´éœ²ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸‹é¢æä¾›äº†å‡ ä¸ª APIï¼š</p>
<ul>
<li><code>undici.fetch</code>ï¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå’Œæµè§ˆå™¨ä¸­çš„ <code>fetch</code> æ–¹æ³•ä¸€è‡´ï¼›</li>
<li><code>undici.request</code>ï¼šå‘èµ·ä¸€ä¸ªè¯·æ±‚ï¼Œå’Œ <code>request</code> åº“æœ‰ç‚¹ç±»ä¼¼ï¼Œè¯¥æ–¹æ³•æ”¯æŒ Promiseï¼›</li>
<li><code>undici.stream</code>ï¼šå¤„ç†æ–‡ä»¶æµï¼Œå¯ä»¥ç”¨æ¥è¿›è¡Œæ–‡ä»¶çš„ä¸‹è½½ï¼›</li>
</ul>
<h3 id="undicifetch">undici.fetch<a class="anchor" href="#undicifetch">Â§</a></h3>
<blockquote>
<p>æ³¨æ„ï¼šè¯¥æ–¹æ³•éœ€è¦ node ç‰ˆæœ¬ &gt;= v16.5.0</p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/202110151429588.png" alt=""></p>
<p>åœ¨é€šè¿‡ <code>undici.fetch</code> è¯·æ±‚æœåŠ¡ä¹‹å‰ï¼Œéœ€è¦å…ˆé€šè¿‡ <code>koa</code> å¯åŠ¨ä¸€ä¸ªç®€å•ç™»å½•æœåŠ¡ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">Koa</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> method<span class="token punctuation">,</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token property-access">request</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token property-access">account</span> <span class="token operator">===</span> <span class="token string">'shenfq'</span> <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> <span class="token string">'123456'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
          mobile<span class="token operator">:</span> <span class="token string">'130xxxxxx'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword control-flow">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token number">404</span>
  ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3100</span><span class="token punctuation">)</span>
</code></pre>
<p>ä¸Šé¢ä»£ç å¾ˆç®€å•ï¼Œåªæ”¯æŒæ¥å—ä¸€ä¸ª <code>POST</code> æ–¹æ³•åˆ° <code>/login</code> è·¯ç”±ã€‚ä¸‹é¢ä½¿ç”¨ <code>undici.fetch</code> å‘èµ·ä¸€ä¸ª <code>POST</code> è¯·æ±‚ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> fetch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">bootstrap</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="http://localhost:3100/login">http://localhost:3100/login</a>'</span>
  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      account<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'123456'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">,</span> <span class="token string">'è¯·æ±‚å¤±è´¥'</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword control-flow">await</span> rsp<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110151501115.png" alt=""></p>
<p>å¦‚æœå°†è¯·æ±‚çš„æ–¹å¼æ”¹ä¸º <code>GET</code>ï¼Œå°±ä¼šè¿”å› 404ã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110151503708.png" alt=""></p>
<h3 id="undicirequest">undici.request<a class="anchor" href="#undicirequest">Â§</a></h3>
<p><code>undici.request</code> çš„è°ƒç”¨æ–¹å¼ä¸ <code>undici.fetch</code> ç±»ä¼¼ï¼Œä¼ å‚å½¢å¼ä¹Ÿå·®ä¸å¤šã€‚</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> request <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">bootstrap</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="http://localhost:3100/login">http://localhost:3100/login</a>'</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">,</span> statusCode <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">request</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      account<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'123456'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword control-flow">await</span> body<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> json<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110161704543.png" alt=""></p>
<p>åªæ˜¯è¿”å›ç»“æœæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œ<code>request</code> æ–¹æ³•è¿”å›çš„ http å“åº”ç»“æœåœ¨ <code>body</code> å±æ€§ä¸­ï¼Œè€Œä¸”è¯¥å±æ€§ä¹Ÿæ”¯æŒåŒ <code>fetch</code> ç±»ä¼¼çš„ <code>.json()</code>/<code>.text()</code> ç­‰æ–¹æ³•ã€‚</p>
<h4 id="%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82">ä¸­æ–­è¯·æ±‚<a class="anchor" href="#%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82">Â§</a></h4>
<p>å®‰è£… <code>abort-controller</code> åº“ï¼Œç„¶åå®ä¾‹åŒ– <code>abort-controller</code>ï¼Œå°†ä¸­æ–­ä¿¡å·ä¼ å…¥ request é…ç½®ä¸­ã€‚</p>
<pre class="language-autoit"><code class="language-autoit">npm i abort<span class="token operator">-</span>controller
</code></pre>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> undici <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">AbortController</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'abort-controller'</span><span class="token punctuation">)</span>

<span class="token comment">// å®ä¾‹åŒ– abort-controller</span>
<span class="token keyword">const</span> abortController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
undici<span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://127.0.0.1:3100">http://127.0.0.1:3100</a>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  <span class="token comment">// ä¼ å…¥ä¸­æ–­ä¿¡å·é‡</span>
  signal<span class="token operator">:</span> abortController<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> statusCode<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  body<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200948095.png" alt=""></p>
<p>æˆ‘ä»¬è¿è¡Œä»£ç ï¼Œå‘ç°æ˜¯å¯ä»¥è¯·æ±‚æˆåŠŸçš„ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¸»åŠ¨è°ƒç”¨ä¸­æ–­æ–¹æ³•ã€‚</p>
<pre class="language-js"><code class="language-js">undici<span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://127.0.0.1:3100">http://127.0.0.1:3100</a>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  signal<span class="token operator">:</span> abortController<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> statusCode<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'è¯·æ±‚æˆåŠŸ'</span><span class="token punctuation">)</span>
  body<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// æ•è·ç”±äºä¸­æ–­è§¦å‘çš„é”™è¯¯</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// è°ƒç”¨ä¸­æ–­</span>
abortController<span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200949519.png" alt=""></p>
<p>ç°åœ¨è¿è¡Œä»£ç ä¼šå‘ç°ï¼Œå¹¶æ²¡æœ‰è¾“å‡º <code>è¯·æ±‚æˆåŠŸ</code> çš„æ—¥å¿—ï¼Œè¿›å…¥äº† <code>catch</code> é€»è¾‘ï¼ŒæˆåŠŸçš„è¿›è¡Œäº†è¯·æ±‚çš„ä¸­æ–­ã€‚</p>
<h3 id="undicisteam">undici.steam<a class="anchor" href="#undicisteam">Â§</a></h3>
<p><code>undici.steam</code> æ–¹æ³•å¯ä»¥ç”¨æ¥è¿›è¡Œæ–‡ä»¶ä¸‹è½½ï¼Œæˆ–è€…æ¥å£ä»£ç†ã€‚</p>
<h4 id="%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD">æ–‡ä»¶ä¸‹è½½<a class="anchor" href="#%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD">Â§</a></h4>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> stream <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> out <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./å®‹ä»£-å“¥çª‘-é‡‘ä¸é“çº¿.jpg'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="https://img.dpm.org.cn/Uploads/Picture/dc/cegift/cegift6389.jpg">https://img.dpm.org.cn/Uploads/Picture/dc/cegift/cegift6389.jpg</a>'</span>

<span class="token function">stream</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> opaque<span class="token operator">:</span> out <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> opaque <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> opaque<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200915916.gif" alt=""></p>
<h4 id="%E6%8E%A5%E5%8F%A3%E4%BB%A3%E7%90%86">æ¥å£ä»£ç†<a class="anchor" href="#%E6%8E%A5%E5%8F%A3%E4%BB%A3%E7%90%86">Â§</a></h4>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undici <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token comment">// å°† 3100 ç«¯å£çš„è¯·æ±‚ï¼Œä»£ç†åˆ° 80 ç«¯å£</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">undici<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://localhost">http://localhost</a>'</span><span class="token punctuation">)</span>
http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> req
  client<span class="token punctuation">.</span><span class="token method function property-access">stream</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> method<span class="token punctuation">,</span> path<span class="token operator">:</span> url<span class="token punctuation">,</span>opaque<span class="token operator">:</span> res <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> opaque <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> opaque
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3100</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110191823111.png" alt="image-20211019182335058"></p>
<h2 id="%E6%80%BB%E7%BB%93">æ€»ç»“<a class="anchor" href="#%E6%80%BB%E7%BB%93">Â§</a></h2>
<p>æœ¬æ–‡åªæ˜¯ä»‹ç»äº† <code>undici</code> å‡ ä¸ª api çš„ä½¿ç”¨æ–¹å¼ï¼Œçœ‹èµ·æ¥ <code>undici</code> ä¸Šæ‰‹éš¾é“è¿˜æ˜¯æ¯”è¾ƒä½çš„ã€‚ä½†æ˜¯å…¼å®¹æ€§è¿˜ä¸å¤ªè¡Œï¼Œæ¯”å¦‚ï¼Œ<code>fetch</code> åªæ”¯æŒ <code>node@v16.5.0</code> ä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚</p>
<p>å¯¹äºè¿™ç§æ¯”è¾ƒæ–°çš„åº“ï¼Œä¸ªäººè¿˜æ˜¯å»ºè®®å¤šè§‚æœ›ä¸€æ®µæ—¶é—´ï¼Œè™½ç„¶ <code>request</code> å·²ç»åºŸå¼ƒäº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ä¸€äº›ç»è¿‡è¾ƒé•¿æ—¶é—´è€ƒéªŒè¿‡çš„åº“ï¼Œæ¯”å¦‚ï¼Œegg æ¡†æ¶ä¸­ä½¿ç”¨çš„ <a href="https://www.npmjs.com/package/urllib">urllib</a>ï¼Œè¿˜æœ‰ä¸€ä¸ª <a href="https://www.npmjs.com/package/node-fetch">node-fetch</a>ï¼Œä¸Šæ‰‹éš¾é“ä¹Ÿæ¯”è¾ƒä½ï¼Œä¸æµè§ˆå™¨ä¸­çš„ <code>fetch</code> api ä½¿ç”¨æ–¹å¼ä¸€è‡´ã€‚</p></article></section><footer>Powered byÂ <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>