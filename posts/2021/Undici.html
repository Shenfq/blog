<!doctype html><html class="" data-reactroot=""><head><script src="/assets/hm.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/>
<title data-react-helmet="true">介绍一个请求库 — Undici · 自然醒的博客</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">自然醒的博客</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">自然醒的博客</a></h1><p class="description">前端工程师，爱折腾，擅长 JavaScript，欢迎关注我的公众号「自然醒的笔记本」</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/Shenfq" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:shenfq95@foxmail.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/index.html"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#%E5%89%8D%E8%A8%80">前言</a></li><li><a href="#%E4%B8%8A%E6%89%8B">上手</a><ol><li><a href="#undicifetch">undici.fetch</a></li><li><a href="#undicirequest">undici.request</a><ol></ol></li><li><a href="#undicisteam">undici.steam</a><ol></ol></li></ol></li><li><a href="#%E6%80%BB%E7%BB%93">总结</a></li></ol></nav></aside><section class="main"><div class="main_post_meta"><time dateTime="2021/10/19">2021-10-19</time> · <!-- -->shenfq</div><article><h2 id="%E5%89%8D%E8%A8%80">前言<a class="anchor" href="#%E5%89%8D%E8%A8%80">§</a></h2>
<p>在浏览器中，如果想发起一个请求，我们以前会使用到 <code>xhr</code>，不过这种底层 api，往往调用方式比较简陋。为了提高开发效率， jQuery 的 <code>$.ajax</code> 可能是最好的选择，好在后来出现了更加现代化的 <code>fetch</code> api 。</p>
<p>但是考虑到 <code>fetch</code> 的兼容性，而且它也不支持一些全局性的配置，以及请求中断，在实际的使用过程中，我们可能会用到 <code>axios</code> 请求库，来进行一些请求。到了 Node.js 中，几乎都会通过 <code>request</code> 这个库，来进行请求。遗憾的是，<code>request</code> 在两年前就停止维护了，在 Node.js 中需要找到一个能够替代的库还挺不容易的。</p>
<p><img src="https://file.shenfq.com/pic/202110081517709.png" alt=""></p>
<p>在 request 的 <a href="https://github.com/request/request/issues/3143">issues</a> 中，有一个表格推荐了一些在 Node.js 中常用的请求库：</p>
<div class="table_wrapper"><table>
<thead>
<tr>
<th>包名</th>
<th>包大小</th>
<th>API风格</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.npmjs.com/package/node-fetch">node-fetch</a></td>
<td>0.4kb</td>
<td>promise / stream</td>
<td>A light-weight module that brings window.fetch to Node.js</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/got">got</a></td>
<td>48.4kb</td>
<td>promise / stream</td>
<td>Simplified HTTP requests</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/axios">axios</a></td>
<td>11.9kb</td>
<td>promise / stream</td>
<td>Promise based HTTP client for the browser and node.js</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/superagent">superagent</a></td>
<td>18kb</td>
<td>chaining / promise</td>
<td>Small progressive client-side HTTP request library, and Node.js module with the same API, sporting many high-level HTTP client features</td>
</tr>
<tr>
<td><a href="https://www.npmjs.com/package/urllib">urllib</a></td>
<td>816kb</td>
<td>callback / promise</td>
<td>Help in opening URLs (mostly HTTP) in a complex world — basic and digest authentication, redirections, cookies and more.</td>
</tr>
</tbody>
</table></div>
<p>浏览器中使用比较多的 <code>axios</code>，在 Node.js 中并不好用，特别是要进行文件上传的时候，会有很多意想不到的问题。</p>
<p>最近我在网上🏄🏿的时候，发现 Node.js 官方是有一个请求库的：<code>undici</code>，名字取得还挺复杂的。所以，今天的文章就来介绍一下 <code>undici</code>。顺便提一句，<code>undici</code> 是意大利语 <code>11</code> 的意思，好像双十一也快到了，利好茅台🤔。</p>
<blockquote>
<p>Undici means eleven in Italian. 1.1 -&gt; 11 -&gt; Eleven -&gt; Undici. It is also a Stranger Things reference.</p>
</blockquote>
<h2 id="%E4%B8%8A%E6%89%8B">上手<a class="anchor" href="#%E4%B8%8A%E6%89%8B">§</a></h2>
<p>我们可以直接通过 <code>npm</code> 来安装 <code>undici</code>：</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> undici -S
</code></pre>
<p><code>undici</code> 对外暴露一个对象，该对象下面提供了几个 API：</p>
<ul>
<li><code>undici.fetch</code>：发起一个请求，和浏览器中的 <code>fetch</code> 方法一致；</li>
<li><code>undici.request</code>：发起一个请求，和 <code>request</code> 库有点类似，该方法支持 Promise；</li>
<li><code>undici.stream</code>：处理文件流，可以用来进行文件的下载；</li>
</ul>
<h3 id="undicifetch">undici.fetch<a class="anchor" href="#undicifetch">§</a></h3>
<blockquote>
<p>注意：该方法需要 node 版本 &gt;= v16.5.0</p>
</blockquote>
<p><img src="https://file.shenfq.com/pic/202110151429588.png" alt=""></p>
<p>在通过 <code>undici.fetch</code> 请求服务之前，需要先通过 <code>koa</code> 启动一个简单登录服务。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">Koa</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> method<span class="token punctuation">,</span> body <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token property-access">request</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/login'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>method <span class="token operator">===</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token property-access">account</span> <span class="token operator">===</span> <span class="token string">'shenfq'</span> <span class="token operator">&amp;&amp;</span> body<span class="token punctuation">.</span><span class="token property-access">password</span> <span class="token operator">===</span> <span class="token string">'123456'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
          mobile<span class="token operator">:</span> <span class="token string">'130xxxxxx'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword control-flow">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">=</span> <span class="token number">404</span>
  ctx<span class="token punctuation">.</span><span class="token property-access">body</span> <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3100</span><span class="token punctuation">)</span>
</code></pre>
<p>上面代码很简单，只支持接受一个 <code>POST</code> 方法到 <code>/login</code> 路由。下面使用 <code>undici.fetch</code> 发起一个 <code>POST</code> 请求。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> fetch <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">bootstrap</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="http://localhost:3100/login">http://localhost:3100/login</a>'</span>
  <span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      account<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'123456'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">,</span> <span class="token string">'请求失败'</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword control-flow">await</span> rsp<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>rsp<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110151501115.png" alt=""></p>
<p>如果将请求的方式改为 <code>GET</code>，就会返回 404。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> rsp <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110151503708.png" alt=""></p>
<h3 id="undicirequest">undici.request<a class="anchor" href="#undicirequest">§</a></h3>
<p><code>undici.request</code> 的调用方式与 <code>undici.fetch</code> 类似，传参形式也差不多。</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> request <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">bootstrap</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="http://localhost:3100/login">http://localhost:3100/login</a>'</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> body<span class="token punctuation">,</span> statusCode <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">request</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    method<span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'content-type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      account<span class="token operator">:</span> <span class="token string">'shenfq'</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token string">'123456'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token keyword control-flow">await</span> body<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> json<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110161704543.png" alt=""></p>
<p>只是返回结果有点不一样，<code>request</code> 方法返回的 http 响应结果在 <code>body</code> 属性中，而且该属性也支持同 <code>fetch</code> 类似的 <code>.json()</code>/<code>.text()</code> 等方法。</p>
<h4 id="%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82">中断请求<a class="anchor" href="#%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82">§</a></h4>
<p>安装 <code>abort-controller</code> 库，然后实例化 <code>abort-controller</code>，将中断信号传入 request 配置中。</p>
<pre class="language-autoit"><code class="language-autoit">npm i abort<span class="token operator">-</span>controller
</code></pre>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> undici <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">AbortController</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'abort-controller'</span><span class="token punctuation">)</span>

<span class="token comment">// 实例化 abort-controller</span>
<span class="token keyword">const</span> abortController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
undici<span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://127.0.0.1:3100">http://127.0.0.1:3100</a>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  <span class="token comment">// 传入中断信号量</span>
  signal<span class="token operator">:</span> abortController<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> statusCode<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  body<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200948095.png" alt=""></p>
<p>我们运行代码，发现是可以请求成功的，是因为我们没有主动调用中断方法。</p>
<pre class="language-js"><code class="language-js">undici<span class="token punctuation">.</span><span class="token method function property-access">request</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://127.0.0.1:3100">http://127.0.0.1:3100</a>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
  signal<span class="token operator">:</span> abortController<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> statusCode<span class="token punctuation">,</span> body <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'请求成功'</span><span class="token punctuation">)</span>
  body<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 捕获由于中断触发的错误</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 调用中断</span>
abortController<span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200949519.png" alt=""></p>
<p>现在运行代码会发现，并没有输出 <code>请求成功</code> 的日志，进入了 <code>catch</code> 逻辑，成功的进行了请求的中断。</p>
<h3 id="undicisteam">undici.steam<a class="anchor" href="#undicisteam">§</a></h3>
<p><code>undici.steam</code> 方法可以用来进行文件下载，或者接口代理。</p>
<h4 id="%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD">文件下载<a class="anchor" href="#%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD">§</a></h4>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> stream <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> out <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token method function property-access">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./宋代-哥窑-金丝铁线.jpg'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'<a class="token url-link" href="https://img.dpm.org.cn/Uploads/Picture/dc/cegift/cegift6389.jpg">https://img.dpm.org.cn/Uploads/Picture/dc/cegift/cegift6389.jpg</a>'</span>

<span class="token function">stream</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> opaque<span class="token operator">:</span> out <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> opaque <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> opaque<span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110200915916.gif" alt=""></p>
<h4 id="%E6%8E%A5%E5%8F%A3%E4%BB%A3%E7%90%86">接口代理<a class="anchor" href="#%E6%8E%A5%E5%8F%A3%E4%BB%A3%E7%90%86">§</a></h4>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> undici <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'undici'</span><span class="token punctuation">)</span>

<span class="token comment">// 将 3100 端口的请求，代理到 80 端口</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">undici<span class="token punctuation">.</span>Client</span><span class="token punctuation">(</span><span class="token string">'<a class="token url-link" href="http://localhost">http://localhost</a>'</span><span class="token punctuation">)</span>
http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> url<span class="token punctuation">,</span> method <span class="token punctuation">}</span> <span class="token operator">=</span> req
  client<span class="token punctuation">.</span><span class="token method function property-access">stream</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> method<span class="token punctuation">,</span> path<span class="token operator">:</span> url<span class="token punctuation">,</span>opaque<span class="token operator">:</span> res <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> opaque <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> opaque
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3100</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://file.shenfq.com/pic/202110191823111.png" alt="image-20211019182335058"></p>
<h2 id="%E6%80%BB%E7%BB%93">总结<a class="anchor" href="#%E6%80%BB%E7%BB%93">§</a></h2>
<p>本文只是介绍了 <code>undici</code> 几个 api 的使用方式，看起来 <code>undici</code> 上手难道还是比较低的。但是兼容性还不太行，比如，<code>fetch</code> 只支持 <code>node@v16.5.0</code> 以上的版本。</p>
<p>对于这种比较新的库，个人还是建议多观望一段时间，虽然 <code>request</code> 已经废弃了，我们还是使用一些经过较长时间考验过的库，比如，egg 框架中使用的 <a href="https://www.npmjs.com/package/urllib">urllib</a>，还有一个 <a href="https://www.npmjs.com/package/node-fetch">node-fetch</a>，上手难道也比较低，与浏览器中的 <code>fetch</code> api 使用方式一致。</p></article></section><footer>Powered by <a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>