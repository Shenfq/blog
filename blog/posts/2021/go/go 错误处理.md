---
title: Go é”™è¯¯å¤„ç†
author: shenfq
date: 2021/04/28
categories:
- Go
tags:
- Go
- é”™è¯¯å¤„ç†
---

# Go é”™è¯¯å¤„ç†

## æ„é€  error

åœ¨ go è¯­è¨€ä¸­ï¼Œæœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„æ¥å£ï¼š`error`ï¼Œè¯¥æ¥å£è‡ªå¸¦ä¸€ä¸ª `Error()` æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

```go
type error interface {
  Error() string
}
```

è°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¼šè¿”å›å½“å‰é”™è¯¯çš„å…·ä½“ç»“æœã€‚ä¸€èˆ¬æœ‰ä¸‹é¢å‡ ç§æ–¹å¼ç”Ÿæˆ errorã€‚

- `errors.New()`
- `fmt.Errorf()`

### ğŸ› ï¸errors.New()

è°ƒç”¨ `errors.New()` ä¼šè¿”å›ä¸€ä¸ª error ç±»å‹çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å†…éƒ¨ä¼šå®ç°ä¸€ä¸ª `Error()` æ–¹æ³•ï¼Œ è°ƒç”¨è¯¥æ–¹æ³•è¿”å›çš„ç»“æœä¸ºè°ƒç”¨ `errors.New()` æ–¹æ³•æ—¶ä¼ å…¥çš„å†…å®¹ã€‚

```go
import (
	"errors"
	"fmt"
)

func divide(a, b int) (error, int) {
	if b == 0 {
    // è¢«é™¤æ•°ä¸º0ï¼Œåˆ™æ„é€ ä¸€ä¸ª error ç»“æ„ä½“
		return errors.New("è¢«é™¤æ•°ä¸èƒ½ä¸º0"), 0
	}
	var result = a / b
	return nil, result
}

func main() {
	var err error // error ç±»å‹æ•°æ®çš„åˆå§‹å€¼ä¸º nilï¼Œç±»ä¼¼äº js ä¸­çš„ null
	var result int

	err, result = divide(1, 0)

  if err == nil {
    // å¦‚æœ err ä¸º nilï¼Œè¯´æ˜è¿è¡Œæ­£å¸¸
    fmt.Println("è®¡ç®—ç»“æœ", result)
  } else {
    // å¦‚æœ err ä¸ä¸º nilï¼Œè¯´æ˜è¿è¡Œå‡ºé”™
    // è°ƒç”¨ error ç»“æ„ä½“çš„ Error æ–¹æ³•ï¼Œè¾“å‡ºé”™è¯¯åŸå› 
    fmt.Println("è®¡ç®—å‡ºé”™", err.Error())
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢çš„ä»£ç ä¸­ï¼Œç”±äºè°ƒç”¨ `divide` é™¤æ³•æ–¹æ³•æ—¶ï¼Œç”±äºä¼ å…¥çš„è¢«é™¤æ•°ä¸º 0ã€‚ç»è¿‡åˆ¤æ–­ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªç”± `errors.New` æ„é€ çš„ `error` ç±»å‹çš„ç»“æ„ä½“ã€‚

æˆ‘ä»¬å°†è°ƒç”¨ `error.Error()` æ–¹æ³•è¿”å›çš„ç»“æœè¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå¯ä»¥å‘ç°å…¶è¿”å›çš„ç»“æœï¼Œå°±æ˜¯ä¼ å…¥ `New` æ–¹æ³•çš„å€¼ã€‚

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

![](https://file.shenfq.com/pic/20210427164350.png)

### ğŸ› ï¸fmt.Errorf()

é€šè¿‡ `fmt.Errorf()` æ–¹æ³•æ„é€ çš„ error ç»“æ„ä½“ï¼Œä¸è°ƒç”¨  `errors.New()` æ–¹æ³•çš„ç»“æœç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼Œ`fmt.Errorf()` æ–¹æ³•ä¼šè¿›è¡Œä¸€æ¬¡æ•°æ®çš„æ ¼å¼åŒ–ã€‚

```go
func divide(a, b int) (error, int) {
	if b == 0 {
    // å°†å‚æ•°è¿›è¡Œä¸€æ¬¡æ ¼å¼åŒ–ï¼Œæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²æ”¾å…¥ error ä¸­
		return fmt.Errorf("æ•°æ® %d ä¸åˆæ³•", b), 0
	}
	var result = a / b
	return nil, result
}

err, result := divide(1, 0)
fmt.Println("è®¡ç®—å‡ºé”™", err.Error())
```

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

![](https://file.shenfq.com/pic/20210427165114.png)

## panic() ä¸ recover()

### panic()

`panic()` ç›¸å½“äºä¸»åŠ¨åœæ­¢ç¨‹åºè¿è¡Œï¼Œè°ƒç”¨æ—¶ `panic()` æ—¶ï¼Œéœ€è¦ä¼ å…¥ä¸­æ–­åŸå› ã€‚è°ƒç”¨åï¼Œä¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¸­æ–­åŸå› ï¼Œä»¥åŠä¸­æ–­æ—¶çš„è°ƒç”¨å †æ ˆã€‚æˆ‘ä»¬å¯ä»¥æ”¹é€ ä¸€ä¸‹ä¹‹å‰çš„ä»£ç ï¼š

```go
func divide(a, b int) (error, int) {
	if b == 0 {
    // å¦‚æœç¨‹åºå‡ºé”™ï¼Œç›´æ¥åœæ­¢è¿è¡Œ
		panic("è¢«é™¤æ•°ä¸èƒ½ä¸º0")
	}
	var result = a / b
	return nil, result
}

func main() {
  err, result := divide(1, 0)
  fmt.Println("è®¡ç®—å‡ºé”™", err.Error())
}
```

åœ¨è¿è¡Œåˆ° `panic()` å¤„ï¼Œç¨‹åºç›´æ¥ä¸­æ–­ï¼Œå¹¶åœ¨æ§åˆ¶å°æ‰“å°å‡ºäº†ä¸­æ–­åŸå› ã€‚

![](https://file.shenfq.com/pic/20210427174701.png)

`panic()` å¯ä»¥ç†è§£ä¸ºï¼Œjs ç¨‹åºä¸­çš„ `throw new Error()` çš„æ“ä½œã€‚é‚£ä¹ˆï¼Œåœ¨ go ä¸­æœ‰æ²¡æœ‰åŠæ³•ç»ˆæ­¢ `panic()` ï¼Œä¹Ÿå°±æ˜¯ç±»ä¼¼äº `try-catch` çš„æ“ä½œï¼Œè®©ç¨‹åºå›åˆ°æ­£å¸¸çš„è¿è¡Œé€»è¾‘ä¸­å‘¢ï¼Ÿ

### recover()

åœ¨ä»‹ç» `recover()` æ–¹æ³•ä¹‹å‰ï¼Œè¿˜éœ€è¦ä»‹ç»ä¸€ä¸ª go è¯­è¨€ä¸­çš„å¦ä¸€ä¸ªå…³é”®å­—ï¼š`defer`ã€‚

`defer` åçš„è¯­å¥ä¼šåœ¨å‡½æ•°è¿›è¡Œ return æ“ä½œä¹‹å‰è°ƒç”¨ï¼Œå¸¸ç”¨äº`èµ„æºé‡Šæ”¾`ã€`é”™è¯¯æ•è·`ã€`æ—¥å¿—è¾“å‡º`ã€‚

```go
func getData(table, sql) {
  defer ä¸­æ–­è¿æ¥()
  db := å»ºç«‹è¿æ¥(table)
  data := db.select(sql)
  return data
}
```

`defer` åçš„è¯­å¥ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªç±»ä¼¼äºæ ˆçš„æ•°æ®ç»“æ„å†…ï¼Œåœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼Œè¢«å®šä¹‰çš„è¯­å¥æŒ‰é¡ºåºå‡ºæ ˆï¼Œè¶Šåé¢å®šä¹‰çš„è¯­å¥è¶Šå…ˆè¢«è°ƒç”¨ã€‚

```go
func divide(a, b int) int {
  defer fmt.Println("é™¤æ•°ä¸º", b)
  defer fmt.Println("è¢«é™¤æ•°ä¸º", a)

  result := a / b
  fmt.Println("è®¡ç®—ç»“æœä¸º", result)
	return result
}

divide(10, 2)
```

ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°å¼€å§‹è¿è¡Œçš„æ—¶å€™ï¼Œå…ˆé€šè¿‡ `defer` å®šä¹‰äº†ä¸¤ä¸ªè¾“å‡ºè¯­å¥ï¼Œå…ˆè¾“å‡º`é™¤æ•°`ï¼Œåè¾“å‡º`è¢«é™¤æ•°`ã€‚ 

![](https://file.shenfq.com/pic/20210428114124.png)

å®é™…çš„è¿è¡Œç»“æœæ˜¯ï¼š

- å…ˆè¾“å‡ºè®¡ç®—ç»“æœï¼›
- ç„¶åè¾“å‡ºè¢«é™¤æ•°ï¼›
- æœ€åè¾“å‡ºé™¤æ•°ï¼›

è¿™å’Œå‰é¢æåˆ°çš„ï¼Œé€šè¿‡ `defer` å®šä¹‰çš„è¯­å¥ä¼šåœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™ï¼ŒæŒ‰ç…§å‡ºæ ˆçš„æ–¹å¼è¿›è¡Œæ‰§è¡Œï¼Œå…ˆå®šä¹‰çš„åæ‰§è¡Œã€‚`defer` é™¤äº†ä¼šåœ¨å‡½æ•°ç»“æŸçš„æ—¶å€™æ‰§è¡Œï¼Œå‡ºç°å¼‚å¸¸çš„çš„æ—¶å€™ä¹Ÿä¼šå…ˆèµ° `defer` çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨äº† `panic()` æ–¹æ³•åï¼Œç¨‹åºä¸­æ–­è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šå…ˆå°† `defer` å†…çš„è¯­å¥è¿è¡Œä¸€éã€‚

è¿™é‡Œæˆ‘ä»¬é‡æ–°å®šä¹‰ä¹‹å‰çš„ `divide` å‡½æ•°ï¼Œåœ¨æ‰§è¡Œä¹‹å‰åŠ ä¸Šä¸€ä¸ª `defer` è¯­å¥ï¼Œ`defer` åé¢ä¸ºä¸€ä¸ªè‡ªæ‰§è¡Œå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…ä¼šè°ƒç”¨ `recover()` æ–¹æ³•ã€‚

![](https://file.shenfq.com/pic/20210428120154.png)

`recover()` æ–¹æ³•è°ƒç”¨åï¼Œä¼šæ•è·åˆ°å½“å‰çš„ `panic()` æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œè¿”å›ï¼Œå¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œåˆ™è¿”å› `nil`ã€‚

```go
func divide(a, b int) int {
  // ä¸­æ–­ä¹‹å‰ï¼Œè°ƒç”¨ defer åå®šä¹‰çš„è¯­å¥
	defer func() {
		if err := recover(); err != nil {
			fmt.Println("æ•è·é”™è¯¯", err)
		}
	}()

	if b == 0 {
    // å‡½æ•°è¿è¡Œè¢«ä¸­æ–­
		panic("è¢«é™¤æ•°ä¸èƒ½ä¸º0")
		return 0
	}

	return a / b
}

result := divide(1, 0)
fmt.Println("è®¡ç®—ç»“æœ", result)
```

ä¸Šé¢çš„ä»£ç è¿è¡Œåï¼Œæˆ‘ä»¬å‘ç°ä¹‹å‰è°ƒç”¨ `panic()` ä¸­æ–­çš„ç¨‹åºè¢«æ¢å¤äº†ï¼Œè€Œä¸”åé¢çš„è®¡ç®—ç»“æœä¹Ÿæ­£å¸¸è¿›è¡Œè¾“å‡ºäº†ã€‚ 

![](https://file.shenfq.com/pic/20210428120544.png)

è¿™å°±æœ‰ç‚¹ç±»ä¼¼äº `try-catch` çš„é€»è¾‘äº†ï¼Œåªæ˜¯ `recover` éœ€è¦æ”¾åœ¨ `defer` å…³é”®è¯åçš„è¯­å¥ä¸­ï¼Œæ›´åƒæ˜¯ `catch` å’Œ `finally` çš„ç»“åˆã€‚ 